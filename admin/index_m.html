<html>
<head>
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/ol.css">

    <script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../lib/js/ol.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="words.js"></script>

    <script type="text/javascript">
        function showStep(step) {
            currentStep = step;
            if (steps[step]) steps[step]();
            var $container = $('#container');
            $container.find('.wizard-page').hide();
            $('.wizard-page[data-step="' + step + '"]').show();
        }
        var currentStep = null;
        var newInstances;
        var useOpenLayers = true;
        var OSM;
        //var existingInstances;
        var devices;
        var repos       = {};
        var hosts       = [];

        var currentInstallId;
        var geocoder;
        var systemConfig;
        var $stdout     = null;
        var stdout      = '';
        var cmdCallback = null;
        var isFirst     = true;
        var mapLoaded   = false;
        var lastScan    = null;
        var isRunning   = false;
        var showConfig  = []; // Show configuration dialog after the wizard is finished

        function positionReady(position) {
            $('#system_latitude').val(position.coords.latitude.toFixed(8)).trigger('change');
            $('#system_longitude').val(position.coords.longitude.toFixed(8)).trigger('change');
            M.updateTextFields();
        }

        function initOSM(lon, lat) {
            var point = ol.proj.fromLonLat([lon || parseFloat(systemConfig.common.longitude), lat || parseFloat(systemConfig.common.latitude)]);
            if (!OSM) {
                if (navigator.geolocation && !systemConfig.common.longitude) {
                    navigator.geolocation.getCurrentPosition(positionReady);
                }

                OSM = {};
                OSM.markerSource = new ol.source.Vector();

                OSM.markerStyle = new ol.style.Style({
                    image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                        anchor: [0.5, 49],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'pixels',
                        opacity: 0.75,
                        src: '../../img/pin.png'
                    }))
                });

                OSM.oMap = new ol.Map({
                    target: 'step0_map',
                    layers: [
                        new ol.layer.Tile({source: new ol.source.OSM()}),
                        new ol.layer.Vector({
                            source: OSM.markerSource,
                            style: OSM.markerStyle,
                        })
                    ],
                    view: new ol.View({center: point, zoom: 18})
                });

                OSM.marker = new ol.Feature({
                    geometry: new ol.geom.Point(point),
                    name: _('Your home')
                });

                OSM.markerSource.addFeature(OSM.marker);

                OSM.oMap.on('singleclick', function (event) {
                    var lonLat = ol.proj.toLonLat(event.coordinate);
                    $('#system_longitude').val(lonLat[0]);
                    $('#system_latitude').val(lonLat[1]).trigger('change');
                });
            }
            var zoom = OSM.oMap.getView().getZoom();
            OSM.marker.setGeometry(new ol.geom.Point(point));
            OSM.oMap.setView(new ol.View({center: point, zoom: zoom}));
        }

        function step0_initMap () {
            var $button = $('#detectCoordinates');

            $button.removeClass('disabled');

            if (systemConfig && systemConfig.common && systemConfig.common.longitude && systemConfig.common.latitude) {
                if (useOpenLayers) {
                    initOSM();
                } else {
                    var map = new google.maps.Map(document.getElementById('step0_map'), {
                        zoom: 14,
                        center: {lat: parseFloat(systemConfig.common.latitude), lng: parseFloat(systemConfig.common.longitude)}
                    });

                    var marker = new google.maps.Marker({
                        position: {lat: parseFloat(systemConfig.common.latitude), lng: parseFloat(systemConfig.common.longitude)},
                        map: map,
                        title: _('Your home')
                    });
                }
            }

            $button.off('click').on('click', function () {
                var country = $('#system_country').val();
                var city    = $('#system_city').val();
                var address = $('#system_address').val();
                if (!country || !city) {
                    showToast($('.wizard-page[data-page="0"]'), _('Please fill country and city first!'));
                    return false;
                }

                $button.addClass('disabled');
                if (!useOpenLayers) {
                    geocoder = geocoder || new google.maps.Geocoder();
                    geocoder.geocode({address: country + ' ' + city + ' ' + address}, function (results, status) {
                        $button.removeClass('disabled');
                        if (status === google.maps.GeocoderStatus.OK) {
                            var changed = false;
                            var $systemLatitude = $('#system_latitude');
                            if ($systemLatitude.val() != results[0].geometry.location.lat().toFixed(8)) {
                                $systemLatitude.val(results[0].geometry.location.lat().toFixed(8));
                                changed = true;
                            }
                            var $systemLongitude = $('#system_longitude');
                            if ($systemLongitude.val() != results[0].geometry.location.lng().toFixed(8)) {
                                $systemLongitude.val(results[0].geometry.location.lng().toFixed(8));
                                changed = true;
                            }
                            if (changed) {
                                var map = new google.maps.Map(document.getElementById('step0_map'), {
                                    zoom: 14,
                                    center: {lat: parseFloat($systemLatitude.val()), lng: parseFloat($systemLongitude.val())}
                                });
                                var marker = new google.maps.Marker({
                                    position: {lat: parseFloat($systemLatitude.val()), lng: parseFloat($systemLongitude.val())},
                                    map: map,
                                    title: _('Your home')
                                });
                                $('#step0_save').removeClass('disabled');
                                $('#step0_next').addClass('disabled');
                                $('#step0_save_hint').show();
                            }
                        } else {
                            showMessage(_('Cannot get coordinates: %s', status), _('Error'), 'alert');
                        }
                    });
                } else {
                    $.ajax('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(country + ' ' + city + ' ' + address)).done(function(data) {
                        $button.removeClass('disabled');
                        var changed = false;

                        if (!data || !data[0]) {
                            return showError(_('Nothing found'));
                        }

                        var $systemLatitude = $('#system_latitude');
                        if ($systemLatitude.val() != data[0].lat) {
                            $systemLatitude.val(data[0].lat);
                            changed = true;
                        }
                        var $systemLongitude = $('#system_longitude');
                        if ($systemLongitude.val() != data[0].lon) {
                            $systemLongitude.val(data[0].lon);
                            changed = true;
                        }
                        if (changed) {
                            initOSM(parseFloat($systemLongitude.val()), parseFloat($systemLatitude.val()));
                            $('#step0_save').removeClass('disabled');
                            $('#step0_next').addClass('disabled');
                            $('#step0_save_hint').show();
                        }
                    })
                    .fail(function(e) {
                        showError(e, _('Cannot fetch address'));
                    });
                }
            });
        }

        function step0() {
            var $button = $('#detectCoordinates');
            if (!$button.data('inited')) {
                $button.data('inited', true);
                $button.css('font-size', 16);

                $button.addClass('disabled');
                $('#system_longitude').off('change').on('change', function () {
                    initOSM(parseFloat($('#system_longitude').val()), parseFloat($('#system_latitude').val()));
                });
                $('#system_latitude').off('change').on('change', function () {
                    initOSM(parseFloat($('#system_longitude').val()), parseFloat($('#system_latitude').val()));
                });

                $('#step0_save').off('click').on('click', function () {
                    var changed = false;
                    $('.system-settings').each(function () {
                        var attr = $(this).attr('id').substring('system_'.length);
                        var val  = $(this).val();
                        if (systemConfig.common[attr] != val) {
                            systemConfig.common[attr] = val;
                            changed = true;
                        }
                    });
                    if (!systemConfig.common.wizard) {
                        systemConfig.common.wizard = true;
                        changed = true;
                    }
                    if (changed) {
                        socket.emit('setObject', 'system.config', systemConfig, function (err) {
                            if (!err) {
                                $('#step0_save').addClass('disabled');
                                $('#step0_next').removeClass('disabled');
                                $('#step0_save_hint').hide();
                            } else {
                                showMessage(err);
                            }
                        });
                    } else {
                        $('#step0_save').addClass('disabled');
                        $('#step0_next').removeClass('disabled');
                        $('#step0_save_hint').hide();
                    }
                });
            } else {
                if (!mapLoaded) {
                    mapLoaded = true;

                    $('#system_address').attr('placeholder', _('Used only for coordinates detection'));

                    if (!useOpenLayers) {
                        var key1 = 'AIzaSyCIrBRZfZAE';
                        var key2 = '_0C1OplAUy7OXhiWLoZc3eY';
                        var key = key1 + key2;

                        // load google API
                        $.ajax({
                            // please do not miss use this api key!
                            url: 'https://maps.googleapis.com/maps/api/js?key=' + key + '&signed_in=true&callback=step0_initMap',
                            dataType: 'script',
                            cache: true
                        });
                    } else {
                        step0_initMap();
                    }
                }
            }

            socket.emit('getObject', 'system.config', function (err, obj) {
                var changed = false;
                if (!obj || !obj.common) {
                    // must be never active, but...
                    systemConfig = {
                        type: 'config',
                        common: {
                            name: 'system.config',
                            city: '',                  // City for weather
                            country: '',               // Country for weather
                            longitude: '',             // longitude for javascript
                            latitude: '',              // longitude for javascript
                            language: '',              // Default language for adapters. Adapters can use different values.
                            tempUnit: '°C',            // Default temperature units.
                            currency: '',              // Default currency sign.
                            dateFormat: 'DD.MM.YYYY',  // Default date format.
                            isFloatComma: true,        // Default float divider ('.' - false, ',' - true)
                            licenseConfirmed: false,   // If license agreement confirmed,
                            defaultHistory: '',        // Default history instance
                            wizard: false,             // flag is wizard was opened
                            tabs: [                    // Show by default only these tabs
                                'tab-adapters',
                                'tab-instances',
                                'tab-objects',
                                'tab-log',
                                'tab-scenes',
                                'tab-javascript',
                                'tab-text2command-0'
                            ]
                        }
                    };
                    changed = true;
                } else {
                    systemConfig = obj;
                    systemConfig.common.city      = systemConfig.common.city      || '';
                    systemConfig.common.country   = systemConfig.common.country   || '';
                    systemConfig.common.longitude = systemConfig.common.longitude || '';
                    systemConfig.common.latitude  = systemConfig.common.latitude  || '';
                }

                if (!systemConfig.common.currency) {
                    if (systemConfig.common.language === 'ru') {
                        systemConfig.common.currency = '₽';
                    } else if (systemConfig.common.language === 'de') {
                        systemConfig.common.currency = '€';
                    } else {
                        systemConfig.common.currency = '$';
                    }
                    changed = true;
                }

                for (var attr in systemConfig.common) {
                    if (systemConfig.common.hasOwnProperty(attr)) {
                        var $value = $('#system_' + attr);
                        $value.val(systemConfig.common[attr]).change(function () {
                            $('#step0_save').removeClass('disabled');
                            $('#step0_next').addClass('disabled');
                            $('#step0_save_hint').show();
                        }).keyup(function () {
                            $(this).trigger('change');
                        });
                        if ($value.prop('tagName') === 'SELECT') {
                            $value.select();
                        }
                    }
                }
                if (!changed) {
                    $('#step0_save').addClass('disabled');
                    $('#step0_next').removeClass('disabled');
                    $('#step0_save_hint').hide();
                } else {
                    $('#step0_save').removeClass('disabled');
                    $('#step0_next').addClass('disabled');
                    $('#step0_save_hint').show();
                }

                if (isFirst) {
                    isFirst = false;
                    if (systemConfig.common.wizard) {
                        $('#step0_next').trigger('click');
                    }
                    if (!mapLoaded) {
                        mapLoaded = true;

                        $('#system_address').attr('placeholder', _('Used only for coordinates detection'));

                        if (!useOpenLayers) {
                            var key1 = 'AIzaSyCIrBRZfZAE';
                            var key2 = '_0C1OplAUy7OXhiWLoZc3eY';
                            var key = key1 + key2;

                            // load google API
                            $.ajax({
                                // please do not miss use this api key!
                                url: 'https://maps.googleapis.com/maps/api/js?key=' + key + '&signed_in=true&callback=step0_initMap',
                                dataType: 'script',
                                cache: true
                            });
                        } else {
                            step0_initMap();
                        }
                    }
                    initOSM();
                }
                M.updateTextFields();
            });
        }

        // Discover all possible devices
        function step1() {
            var $step1 = $('#step1_discover');
            $('#step1_help1').show();
            $('#step1_text').hide();
            $('#step1_result').hide();
            $('#step1_progressbar').hide();

            var $settings = $('#step1_settings');
            if (!$settings.data('inited')) {
                $settings.data('inited', true);
                $settings.off('click').on('click', function () {
                    document.location = 'settings_m.html' + document.location.search;
                });

                $step1.off('click').on('click', function () {
                    $step1.addClass('disabled');
                    $('#step1_next').addClass('disabled');
                    $('#step1_help1').hide();
                    $('#step1_help2').hide();
                    isRunning = true;

                    var options = [];
                    var ignore  = [];
                    $('.step1-methods')
                        .prop('disabled', true)
                        .each(function () {
                            if ($(this).prop('checked')) {
                                options.push($(this).data('method'));
                            } else {
                                ignore.push($(this).data('method'));
                            }
                        });
                    if (typeof Storage  !== 'undefined') {
                        localStorage.setItem('discovery_ignore', JSON.stringify(ignore));
                    }

                    sendTo(null, 'browse', options, function (result) {
                        $('.step1-methods').prop('disabled', false);

                        isRunning = false;
                        $('#step1_text').hide();
                        $('#step1_result').hide();
                        $('#step1_progressbar').hide();
                        $('#step1_next').removeClass('disabled');
                        $step1.removeClass('disabled');
                        if (result.error) {
                            showMessage(result.error, _('Error'), 'alert');
                            newInstances = [];
                        } else {
                            newInstances = result.newInstances;
                            devices      = result.devices;
                            showStep(currentStep + 1);
                        }
                    });
                });
            }


            $('#step1_next').addClass('disabled');
            $('#step1_help2').hide();

            getIsAdapterAlive(function (isAlive) {
                if (!isAlive) {
                    $step1.addClass('disabled');
                }
            });
            step2_litsMethods();
        }

        function step2_litsMethods() {
            sendTo(null, 'listMethods', null, function (result) {
                var text = '<div class="row"><div class="col s12"><h6 class="title">' + _('Use following methods:') + '</h6></div></div>';

                var ignore = [];
                if (typeof Storage  !== 'undefined') {
                    ignore = localStorage.getItem('discovery_ignore');
                    if (ignore) {
                        try {
                            ignore = JSON.parse(ignore);
                        } catch (r) {
                            ignore = [];
                        }
                    }
                }

                if (!ignore) {
                    ignore = [];
                }

                // because of the problem on some systems, deactivate it by default. User must to activate it actively
                if (ignore.indexOf('serial') === -1) {
                    ignore.push('serial');
                }

                result = result || {};
                for (var r in result) {
                    if (result.hasOwnProperty(r)) {
                        text += '<div class="row"><div class="col s12"><input type="checkbox" class="step1-methods filled-in" data-method="' + r + '" ' + ((ignore.indexOf(r) !== -1) ? '' : 'checked') + '/><span>' + _(r) /*+ ' [' + result[r].type + ']' */+ '</span></div></div>';
                    }
                }
                var $methods = $('#step1_methods');
                $methods.show().find('.text').html(text);
                // workaround for materialize checkbox problem
                $methods.find('input[type="checkbox"]+span').off('click').on('click', function () {
                    var $input = $(this).prev();
                    if (!$input.prop('disabled')) {
                        $input.prop('checked', !$input.prop('checked')).trigger('change');
                    }
                });

                socket.emit('getObject', 'system.discovery', function (err, obj) {
                    if (obj) {
                        if (obj.native.newInstances) {
                            newInstances = obj.native.newInstances;
                        }
                        if (obj.native.devices) {
                            devices = obj.native.devices;
                        }
                        if (obj.native.lastScan) lastScan = obj.native.lastScan;
                    }
                    if (lastScan) {
                        $('#step1_help3').show().find('.text').html(_('Last scan on %s', formatTime(new Date(lastScan))));
                    } else {
                        $('#step1_help3').hide();
                    }
                    newInstances = newInstances || [];

                    if (newInstances.length) {
                        $('#step1_next').removeClass('disabled');
                        $('#step1_help2').show();
                    } else {
                        $('#step1_next').addClass('disabled');
                        $('#step1_help2').hide();
                    }
                });
            });
        }

        function getExistingInstances(callback) {
            socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.', endkey: 'system.adapter.\u9999'}, function (err, doc) {
                if (err) {
                    if (callback) callback ([]);
                } else {
                    if (doc.rows.length === 0) {
                        if (callback) callback ([]);
                    } else {
                        var res = [];
                        for (var i = 0; i < doc.rows.length; i++) {
                            res.push(doc.rows[i].value);
                        }
                        if (callback) callback (res);
                    }
                }
            });
        }

        function buildComment(comment) {
            if (!comment) {
                return _('new');
            }
            if (typeof comment === 'string') return comment;
            var text = '';
            if (comment.add) {
                text += _('new');
                if (typeof comment.add === 'object' &&  + comment.add.length !== undefined) {
                    text += ': ';
                    if (comment.add.length <= 5) {
                        text += comment.add.join(', ');
                    } else {
                        text += _('%s devices', comment.add.length);
                    }
                } else if (typeof comment.add === 'string' || typeof comment.add === 'number') {
                    text += ': ';
                    text += comment.add;
                }
            }
            if (comment.changed) {
                text += (text ? ', ' : '') + _('changed');
                if (typeof comment.changed === 'object' &&  + comment.changed.length !== undefined) {
                    text += ': ';
                    if (comment.changed.length <= 5) {
                        text += comment.changed.join(', ');
                    } else {
                        text += _('%s devices', comment.changed.length);
                    }
                } else if (typeof comment.changed === 'string' || typeof comment.changed === 'number') {
                    text += ': ';
                    text += comment.changed;
                }
            }
            if (comment.extended) {
                text += (text ? ', ' : '') + _('extended');
                if (typeof comment.extended === 'object' &&  + comment.extended.length !== undefined) {
                    text += ': ';
                    if (comment.extended.length <= 5) {
                        text += comment.extended.join(', ');
                    } else {
                        text += _('%s devices', comment.extended.length);
                    }
                } else if (typeof comment.extended === 'string' || typeof comment.extended === 'number') {
                    text += ': ';
                    text += comment.extended;
                }
            }
            if (comment.text) {
                text += (text ? ', ' : '') + comment.text;
            }
            return text;
        }

        function disableDependencies(id) {
            var recheck = false;
            // disable all that depends on it
            for (var ii = 0; ii < newInstances.length; ii++) {
                if (newInstances[ii].comment.required && newInstances[ii].comment.required.indexOf(id) !== -1) {
                    var $check = $('.step2-allow[data-id="' + ii + '"]');
                    if ($check.prop('checked')) {
                        $check.prop('checked', false);
                        recheck = true;
                        disableDependencies(newInstances[ii]._id);
                    }
                }
            }
            return recheck;
        }

        function step2CheckNextAllow() {
            var allow = false;
            var $allow = $('.step2-allow');
            if (this !== window) {
                var index = $(this).data('id');
                if ($(this).prop('checked')) {
                    if (newInstances[index].comment && newInstances[index].comment.required) {
                        if (typeof newInstances[index].comment.required === 'string') newInstances[index].comment.required = [newInstances[index].comment.required];
                        for (var r = 0; r < newInstances[index].comment.required.length; r++) {
                            for (var i = 0; i < newInstances.length; i++) {
                                if (newInstances[i]._id === newInstances[index].comment.required[r]) {
                                    $('.step2-allow[data-id="' + i + '"]').prop('checked', true);
                                }
                            }
                        }
                    }
                } else {
                    // disable all that depends on it
                    disableDependencies(newInstances[index]._id);
                }
            }


            $allow.each(function () {
                if ($(this).prop('checked')) {
                    allow = true;
                    return false;
                }
            });
            if (allow) {
                $('#step2_next').removeClass('disabled');
            } else {
                $('#step2_next').addClass('disabled');
            }
        }

        function step2_getHosts(callback) {
            if (hosts && hosts.length) {
                return callback(hosts);
            } else {
                socket.emit('getObjectView', 'system', 'host', {startkey: 'system.host.', endkey: 'system.host.\u9999'}, function (err, res) {
                    if (!err && res) {
                        hosts = [];
                        for (var i = 0; i < res.rows.length; i++) {
                            hosts.push(res.rows[i].id.substring('system.host.'.length));
                        }
                    }
                    if (callback) callback(hosts);
                });

            }
        }

        function formatTime(a) {
            var yyyy = a.getFullYear();
            var mm  = a.getMonth()    < 9 ? '0' + (a.getMonth() + 1) : (a.getMonth() + 1); // getMonth() is zero-based
            var dd  = a.getDate()    < 10 ? '0' + a.getDate()    : a.getDate();
            var hh  = a.getHours()   < 10 ? '0' + a.getHours()   : a.getHours();
            var min = a.getMinutes() < 10 ? '0' + a.getMinutes() : a.getMinutes();
            var ss  = a.getSeconds() < 10 ? '0' + a.getSeconds() : a.getSeconds();
            return yyyy + '-' + mm + '-' + dd + ' ' + hh + ':' + min  +':' + ss;
        }

        function step2_showHideInstances() {
            $('.step2-instance').show();

            var hasAcknowledged = false;
            $('.step2-ack').each(function () {
                if ($(this).prop('checked')) {
                    hasAcknowledged = true;
                    return false;
                }
            });
            var $acknowledged = $('#step2-show-acknowledged');
            if (hasAcknowledged) {
                $acknowledged.show()
            } else {
                $acknowledged.hide();
            }

            if (!$acknowledged.hasClass('green')) {
                $('.step2-instance-acknowledged').hide();
            }
            if (!$('#step2-show-suggested').hasClass('green')) {
                $('.step2-instance-suggested').hide();
            }
        }

        // show list of found instances
        // Create instances automatically
        function step2() {
            var $step2_selectall = $('#step2_selectall');
            if (!$step2_selectall.data('inited')) {
                $step2_selectall.data('inited', true);
                $step2_selectall.off('click').on('click', function () {
                    $('.step2-allow').each(function () {
                        $(this).prop('checked', true);
                    });
                    step2CheckNextAllow();
                });

                $('#step2_deselectall').off('click').on('click', function () {
                    $('.step2-allow').each(function () {
                        $(this).prop('checked', false);
                    });
                    step2CheckNextAllow();
                });



                $('#step2-show-acknowledged').off('click').on('click', function () {
                    var isShow = $(this).hasClass('green');
                    if (isShow) {
                        $(this).removeClass('green');
                    } else {
                        $(this).addClass('green');
                    }
                    step2_showHideInstances();
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('wizard.show.acknowledged', $(this).hasClass('green'));
                    }
                });

                $('#step2-show-suggested').off('click').on('click', function () {
                    var isShow = $(this).hasClass('green');
                    if (isShow) {
                        $(this).removeClass('green');
                    } else {
                        $(this).addClass('green');
                    }
                    step2_showHideInstances();
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('wizard.show.suggested', $(this).hasClass('green'));
                    }
                });

                if (typeof Storage !== 'undefined') {
                    if (localStorage.getItem('wizard.show.acknowledged') === 'true') {
                        $('#step2-show-acknowledged').addClass('green');
                    }
                    if (localStorage.getItem('wizard.show.suggested') === 'true') {
                        $('#step2-show-suggested').addClass('green');
                    }
                }
            }

            step2_getHosts(function () {
                var $instances = $('#step2_instances');

                var text = '';
                var hasSuggested = false;
                var hasAcknowledged = false;
                if (newInstances) {
                    for (var i = 0; i < newInstances.length; i++) {
                        if (newInstances[i].comment.ack) hasAcknowledged = true;
                        if (newInstances[i].comment.advice) hasSuggested = true;

                        text += '<tr data-id="' + i + '" class="step2-instance ' +
                            (newInstances[i].comment.ack    ? 'step2-instance-acknowledged ' : '') +
                            (newInstances[i].comment.advice ? 'step2-instance-suggested ' : '') +
                            '">';
                        text += '<td><input type="checkbox" data-id="' + i + '" class="step2-allow filled-in"/><span></span></td>';
                        text += '<td>' + newInstances[i]._id.substring('system.adapter.'.length) + '</td>';
                        if (hosts.length > 1) {
                            text += '<td><select class="step2-host" data-id="' + i + '" ' + (newInstances[i].common.host ? 'disabled' : '') + '>';
                            for (var h = 0; h < hosts.length; h++) {
                                text += '<option value="' + hosts[h] + '" ' + (newInstances[i].common.host === hosts[h] ? 'selected' : '') + '>' + hosts[h] + '</option>';
                            }
                            text += '</select></td>';
                        }
                        text += '<td>' + buildComment(newInstances[i].comment) + '</td>';
                        text += '<td style="text-align: center"><input type="checkbox" data-id="' + i + '" ' + (newInstances[i].comment.ack ? 'disabled checked' : '') + ' class="step2-ack"/><span></span></td>';
                        text += '</tr>';
                    }
                }
                if (lastScan) {
                    $('#step2_header').html(_('Create instances automatically') + ' - ' + _('Last scan on %s', formatTime(new Date(lastScan))));
                } else {
                    $('#step2_header').html(_('Create instances automatically'));
                }
                if (hosts.length > 1) {
                    $('.wizard-table-host').show();
                } else {
                    $('.wizard-table-host').hide();
                }
                $instances.html(text);

                // workaround for materialize checkbox problem
                $instances.find('input[type="checkbox"]+span').off('click').on('click', function () {
                    var $input = $(this).prev();
                    if (!$input.prop('disabled')) {
                        $input.prop('checked', !$input.prop('checked')).trigger('change');
                    }
                });

                var $acknowledged = $('#step2-show-acknowledged');
                var $suggested    = $('#step2-show-suggested');
                if (!hasAcknowledged) {
                    $acknowledged.hide();
                } else {
                    $acknowledged.show();
                }
                if (!hasSuggested) {
                    $suggested.hide();
                } else {
                    $suggested.show();
                }
                if (!$acknowledged.hasClass('green')) {
                    $('.step2-instance-acknowledged').hide();
                }
                if (!$suggested.hasClass('green')) {
                    $('.step2-instance-suggested').hide();
                }
                $('.step2-allow').change(step2CheckNextAllow);
                $('.step2-ack').change(function () {
                    var i = $(this).data('id');
                    $(this).prop('disabled', true);
                    newInstances[i].comment.ack = true;
                    var $instance = $('.step2-instance[data-id="' + i + '"]');
                    $instance.addClass('step2-instance-acknowledged');

                    socket.emit('getObject', 'system.discovery', function (err, obj) {
                        var found = false;
                        if (obj && obj.native && obj.native.newInstances) {
                            for (var n = 0; n < obj.native.newInstances.length; n++) {
                                if (obj.native.newInstances[n]._id === newInstances[i]._id) {
                                    found = true;
                                    obj.native.newInstances[n].comment.ack = true;
                                    break;
                                }
                            }
                        }
                        if (found) {
                            socket.emit('setObject', 'system.discovery', obj, function (err) {
                                if (err) console.error(err);
                            });
                        } else {
                            showMessage(_('Please close dialog and open it anew!'), _('Unknown error'), 'alert');
                        }
                        step2_showHideInstances();
                    });
                });

                step2CheckNextAllow();
            });
        }

        function step3_showLicenseDialog(adapter, callback) {
            var $dialogLicense = $('#dialog-license');
            $dialogLicense.modal({
                dismissible: false
            });

            // Is adapter installed
            if (adapter.installed || !adapter.licenseUrl) {
                callback(true);
                return;
            }
            $('#license_language').hide();
            $('#license_diag').hide();
            $('#license_language_label').hide();
            $('#license_checkbox').hide();

            var timeout = setTimeout(function () {
                timeout = null;
                callback(true);
            }, 10000);

            // Workaround
            // https://github.com/ioBroker/ioBroker.vis/blob/master/LICENSE =>
            // https://raw.githubusercontent.com/ioBroker/ioBroker.vis/master/LICENSE
            if (adapter.licenseUrl.indexOf('github.com') !== -1) {
                adapter.licenseUrl = adapter.licenseUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }

            socket.emit('httpGet', adapter.licenseUrl, function (error, response, body) {
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;

                    if (!error && body) {
                        $dialogLicense.css({'z-index': 200});
                        body = body.replace(/\r\n/g, '<br>');
                        body = body.replace(/\n/g, '<br>');
                        $('#license_text').html(body);
                        $dialogLicense.find('#license_agree').off('click').on('click', function () {
                            callback && callback(true);
                            callback = null;
                            $('#license_text').html('');
                        });
                        $dialogLicense.find('#license_non_agree').off('click').on('click', function () {
                            callback && callback(false);
                            callback = null;
                            $('#license_text').html('');
                        });
                        $dialogLicense.modal('open');
                    } else {
                        showMessage(_('Cannot get license agreement'), _('No internet'), 'alert');
                        callback && callback(false);
                        callback = null;
                    }
                }
            });
        }

        function step3_waitTillInstalled(id, template, timeout, callback, count) {
            count = count || 0;

            if (template && template.common.mode !== 'daemon' && template.common.mode !== 'once') {
                callback && callback();
            } else {
                socket.emit('getState', id, function (err, state) {
                    console.log(id + '(' + count + '): ' + (state ? state.val : 'null'));
                    if (state && state.val) {
                        callback && callback();
                    } else {
                        count++;
                        if (count * 1000 > timeout) {
                            // may be "once" was too fast and finished in less than a second
                            callback && callback((template && template.common.mode === 'once') ? '' : 'timeout');
                        } else {
                            setTimeout(function () {
                                step3_waitTillInstalled(id, template, timeout, callback, count + 1);
                            }, 1000);
                        }
                    }
                });
            }
        }

        function step3_getAdaptersInfo(host, callback) {
            if (!host) {
                console.error('step3_getAdaptersInfo: empty host');
                return;
            }

            if (!callback) throw 'Callback cannot be null or undefined';

            if (repos[host]) {
                return callback(repos[host].curRepository, repos[host].curInstalled, host);
            }

            repos[host] = {curRepository: null, curInstalled: null};

            socket.emit('sendToHost', host, 'getRepository', {}, function (_repository) {
                if (_repository === 'permissionError') {
                    console.error('May not read "getRepository"');
                    _repository = {};
                }

                repos[host].curRepository = _repository || {};
                if (repos[host].curRepository && repos[host].curInstalled) {
                    callback(repos[host].curRepository, repos[host].curInstalled, host);
                }
            });

            socket.emit('sendToHost', host, 'getInstalled', null, function (_installed) {
                if (_installed === 'permissionError') {
                    console.error('May not read "getInstalled"');
                    _installed = {};
                }

                repos[host].curInstalled = _installed || {};
                if (repos[host].curRepository && repos[host].curInstalled) {
                    callback(repos[host].curRepository, repos[host].curInstalled, host);
                }
            });
        }

        function step3_getAdapterInfo(host, name, callback) {
            socket.emit('sendToHost', host, 'getInstalledAdapter', name, callback);
        }

        function step3_addInstance(template, obj, wasInstalled, callback) {
            template._id     = obj._id;
            template.common.enabled = true;
            template.type    = 'instance';
            template.comment = obj.comment;
            if (!wasInstalled) {
                if (template && template.common.license && template.common.license !== 'MIT') {
                    if (!template.common.licenseUrl) {
                        template.common.licenseUrl = 'https://raw.githubusercontent.com/ioBroker/ioBroker.' + template.common.name + '/master/LICENSE'
                    }
                    if (typeof template.common.licenseUrl === 'object') {
                        template.common.licenseUrl = template.common.licenseUrl[systemLang] || template.common.licenseUrl.en;
                    }
                    // Workaround
                    // https://github.com/ioBroker/ioBroker.vis/blob/master/LICENSE =>
                    // https://raw.githubusercontent.com/ioBroker/ioBroker.vis/master/LICENSE
                    if (template.common.licenseUrl.indexOf('github.com') !== -1) {
                        template.common.licenseUrl = template.common.licenseUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                    }
                    // Show license dialog!
                    step3_showLicenseDialog(template.common, function (isAgree) {
                        if (isAgree) {
                            step3_addInstance(template, obj, true, callback);
                        } else {
                            $('.step3-progress[data-id="' + template._id + '"]').html(_('license not agree')).removeClass('process').addClass('error');
                            callback && callback(_('license not agree'));
                        }
                    });
                    return;
                }
            }

            for (var c in obj.common) {
                if (obj.common.hasOwnProperty(c)) template.common[c] = obj.common[c];
            }
            for (var n in obj.native) {
                if (obj.native.hasOwnProperty(n)) template.native[n] = obj.native[n];
            }
            var $text = $('.step3-progress[data-id="' + obj._id + '"]');
            $text.html(_('check parameters')).addClass('warn');
            step3_askParameters(template, function (err, template) {
                if (!template) {
                    $text.html(_('canceled')).removeClass('process').addClass('warn');
                    callback && callback(err || 'No template');
                    return;
                }
                $text.html(_('wait till installed')).addClass('warn');
                template = JSON.parse(JSON.stringify(template));
                if (template.comment) delete template.comment;

                socket.emit('setObject', template._id, template, function (err) {
                    step3_waitTillInstalled(obj._id + '.alive', template, 20000, function (err) {
                        if (err) {
                            $text.html(_('timeout by install')).removeClass('process').addClass('error');
                            callback && callback(err);
                        } else {
                            // Remove it from list
                            socket.emit('getObject', 'system.discovery', function (err, discObj) {
                                var changed = false;
                                if (discObj && discObj.native.newInstances) {
                                    // remove obj.native.newInstances
                                    for (var i = 0; i < discObj.native.newInstances.length; i++) {
                                        if (template._id === discObj.native.newInstances[i]._id) {
                                            discObj.native.newInstances.splice(i, 1);
                                            changed = true;
                                            break;
                                        }
                                    }
                                }
                                if (changed) {
                                    newInstances = discObj.native.newInstances;
                                    socket.emit('setObject', 'system.discovery', discObj, function (err) {
                                        $text.html(_('started')).addClass('success').removeClass('process').removeClass('warn');
                                        callback && callback();
                                    });
                                } else {
                                    $text.html(_('started')).addClass('success').removeClass('process').removeClass('warn');
                                    if (obj.comment.showConfig) {
                                        showConfig.push(obj._id);
                                    }
                                    callback && callback();
                                }
                            });
                        }
                    });
                });
            });
        }

        function getParam(name, obj) {
            var parts = name.split('.');
            do {
                var attr = parts.shift();
                if (typeof obj === 'object') {
                    obj = obj[attr];
                } else {
                    obj = undefined;
                    break;
                }
            } while (parts.length);

            return obj;
        }

        function setParam(name, obj, value) {
            var parts = name.split('.');
            if (parts.length === 1) {
                obj[name] = value;
                return;
            }

            do {
                var attr = parts.shift();
                if (!parts.length) {
                    obj[attr] = value;
                    break;
                }
                if (typeof obj === 'object') {
                    obj = obj[attr];
                } else {
                    obj = {};
                    break;
                }
            } while (parts.length);
        }

        /*
         Types of parameters:
         - type=password, def=default value
         - type=checkbox, def=default value
         - type=select, options={value1: TextValule1, value2=TextValue2}
         - type=link, def = URL
         - type=comment, style="CSS style", def=text
         - type=text

         - name = Name of attribute like "native.ip" or "native.port"
         - title = Title of input
         */
        function step3_askParameters(obj, callback) {
            if (obj.comment && obj.comment.inputs) {
                // check if all required parameters are set
                var params = [];
                for (var p = 0; p < obj.comment.inputs.length; p++) {
                    var name = obj.comment.inputs[p].name;
                    var val = name ? getParam(obj.comment.inputs[p].name, obj) : '';
                    if (name === undefined || val === undefined || val === obj.comment.inputs[p].def) {
                        params.push(obj.comment.inputs[p]);
                    }
                }

                if (params.length) {
                    var text = '';
                    text += '<div class="row"><div class="col s12 description">' + _('Description') + '</div>';
                    text += '<div class="col s12">' + buildComment(obj.comment) + '</div></div>';


                    for (var pp = 0; pp < params.length; pp++) {
                        text += '<div class="row"><div class="col s12">';
                        if (params[pp].type === 'password') {
                            text += '<input data-required="' + !!params[pp].required + '" data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="params" type="password"/>';
                            text += '<label>' + _(params[pp].title) + (params[pp].title ? ':' : '') + ' </label>';
                            text += '</div></div><div class="row"><div class="col s12">';
                            text += '<input data-required="' + !!params[pp].required + '" data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="passRepeat" type="password"/>';
                            text += '<label>' + _('passwordRepeat') + '';
                        } else if (params[pp].type === 'checkbox') {
                            text += '<input data-required="' + !!params[pp].required + '" data-name="' + params[pp].name + '" type="checkbox" ' + (params[pp].def ? 'checked' : '') + ' class="params" />';
                            text += '<span>' + _(params[pp].title) + (params[pp].title ? ':' : '') + ' </span>';
                        } else if (params[pp].type === 'select') {
                            text += '<select data-required="' + !!params[pp].required + '" data-name="' + params[pp].name + '" class="params">';
                            for (var op in params[pp].options) {
                                if (!params[pp].options.hasOwnProperty(op)) continue;
                                text += '<option value="' + op + '" ' + (params[pp].def === op ? 'selected' : '') + '>' + (params[pp].options[op] !== null ? params[pp].options[op] : op) + '</option>';
                            }
                            text += '</select>';
                            text += '<label>' + _(params[pp].title) + (params[pp].title ? ':' : '') + ' </label>';
                        } else if (params[pp].type === 'link') {
                            text += '<a class="btn" href="' + (params[pp].link || params[pp].def) + '" target="' + params[pp].title.replace(/\s/g, '_') + '">' + (params[pp].link || params[pp].def) + '</a>';
                            //text += '<label>' + _(params[pp].title) + (params[pp].title ? ':' : '') + ' </label>';
                        } else if (params[pp].type === 'comment') {
                            text += '<span style="' + (params[pp].style || '') + '">' + (params[pp].comment || params[pp].def) + '</span>';
                        } else{
                            text += '<input data-required="' + !!params[pp].required + '" data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="params" />';
                            text += '<label>' + _(params[pp].title) + (params[pp].title ? ':' : '') + ' </label>';
                        }
                        text += '</div></div>';
                    }
                    text += '</table>';
                    var $dialog = $('#dialog-parameters');
                    $dialog.find('.controls').html(text);
                    $dialog.find('select').select();

                    // workaround for materialize checkbox problem
                    $dialog.find('input[type="checkbox"]+span').off('click').on('click', function () {
                        var $input = $(this).prev();
                        if (!$input.prop('disabled')) {
                            $input.prop('checked', !$input.prop('checked')).trigger('change');
                        }
                    });

                    $dialog.find('title').html(_('Edit parameters for %s', obj._id.substring('system.adapter.'.length)));
                    $dialog.data('callback', callback);
                    $dialog.data('obj', obj);
                    $dialog.modal('open');
                } else {
                    callback(null, obj);
                }
            } else {
                callback(null, obj);
            }
        }

        function step3_cmdExec(host, cmd, callback) {
            /*        $stdout.val('');
             $dialogCommand.dialog('open');
             stdout = '$ ./iobroker ' + cmd;
             $stdout.val(stdout);
             // genereate the unique id to coordinate the outputs
             cmdCallback = callback;*/
            currentInstallId = Math.floor(Math.random() * 0xFFFFFFE) + 1;
            cmdCallback = callback;

            socket.emit('cmdExec', host, currentInstallId, cmd, function (err) {
                if (err) {
                    cmdCallback && cmdCallback(err);
                    stdout += '\n' + _(err);
                    if ($stdout) $stdout.val(stdout);
                    cmdCallback = null;
                } else {
                    if (cmdCallback) cmdCallback();
                }
            });
        }

        function step3_addAdapter(host, name, callback) {
            step3_getAdaptersInfo(host, function (repo, installed) {
                var _obj = repo[name];

                if (!_obj) _obj = installed[name];

                if (_obj && _obj.license && _obj.license !== 'MIT') {
                    // Show license dialog!
                    step3_showLicenseDialog(_obj, function (isAgree) {
                        if (isAgree) {
                            step3_cmdExec(host, 'install ' + name, function (exitCode) {
                                callback && callback(exitCode !== 51 ? exitCode : 0); // 1 is yet installed
                            });
                        } else {
                            callback && callback(_('license not agree'));
                        }
                    });
                } else {
                    step3_cmdExec(host, 'install ' + name, function (exitCode) {
                        callback && callback(exitCode !== 51 ? exitCode : 0);
                    });
                }
            });
        }

        function step3_processInstance(task, callback) {
            $('.step3-progress[data-id="' + task._id + '"]').html(_('Install package')).addClass('process');

            // get Object
            socket.emit('getObject', task._id, function (err, obj) {
                if (obj && task.comment.add) {
                    $('.step3-progress[data-id="' + task._id + '"]').html(_('yet exists')).removeClass('process').addClass('error');
                    callback && callback();
                } else {
                    if (obj) {
                        // we changing the existing instance
                        step3_addInstance(obj, task, false, callback);
                    } else {
                        // try to get system.adapter.NAME
                        var name = task._id.split('.');
                        name.pop();
                        name = name.join('.');

                        // if adapter installed or not
                        socket.emit('getObject', name, function (err, template) {
                            if (template) {
                                step3_addInstance(template, task, false, callback);
                            } else {
                                name = name.substring('system.adapter.'.length);
                                if (repos && repos[task.common.host] && repos[task.common.host].curInstalled[name]) {
                                    step3_getAdapterInfo(task.common.host, name, function (template) {
                                        if (err) {
                                            $('.step3-progress[data-id="' + task._id + '"]').html(_('Error: %s', err)).removeClass('process').addClass('error');
                                            callback && callback(err);
                                        } else {
                                            if (!template.native) {
                                                // add adapter
                                                step3_addAdapter(task.common.host, name, function (err) {
                                                    if (err) {
                                                        $('.step3-progress[data-id="' + task._id + '"]').html(_('Error: %s', err)).removeClass('process').addClass('error');
                                                        callback && callback(err);
                                                    } else {
                                                        repos[task.common.host] = null;
                                                        step3_getAdapterInfo(task.common.host, name, function (template) {
                                                            if (template) {
                                                                if (template.instanceObjects !== undefined) delete template.instanceObjects;
                                                                if (template.objects !== undefined) delete template.objects;
                                                                if (template._existing !== undefined) delete template._existing;
                                                                step3_addInstance(template, task, true, callback);
                                                            } else {
                                                                $('.step3-progress[data-id="' + task._id + '"]').html(_('No io-package.json found')).removeClass('process').addClass('error');
                                                                callback && callback(_('No io-package.json found'));
                                                            }
                                                        });
                                                    }
                                                });
                                            } else {
                                                step3_addInstance(template, task, false, callback);
                                            }
                                        }
                                    });
                                } else {
                                    // add adapter
                                    step3_addAdapter(task.common.host, name, function (err) {
                                        if (err) {
                                            $('.step3-progress[data-id="' + task._id + '"]').html(_('Error: %s', err)).removeClass('process').addClass('error');
                                            callback && callback(err);
                                        } else {
                                            repos[task.common.host] = null;
                                            step3_getAdapterInfo(task.common.host, name, function (template) {
                                                if (template) {
                                                    if (template.instanceObjects !== undefined) delete template.instanceObjects;
                                                    if (template.objects !== undefined) delete template.objects;
                                                    if (template._existing !== undefined) delete template._existing;
                                                    step3_addInstance(template, task, true, callback);
                                                } else {
                                                    $('.step3-progress[data-id="' + task._id + '"]').html(_('No io-package.json found')).removeClass('process').addClass('error');
                                                    callback && callback(_('No io-package.json found'));
                                                }
                                            });
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
            });
        }

        function step3_processInstances(instances, errors, callback) {
            if (!instances || !instances.length) {
                callback();
                return;
            }
            var task  = instances.shift();
            var found = false;

            if (task.comment.required) {
                for (var r = 0; r < task.comment.required.length; r++) {
                    if (errors.indexOf(task.comment.required[r]) !== -1) {
                        found = true;
                        break;
                    }
                }
            }
            if (found) {
                $('.step3-progress[data-id="' + task._id + '"]').html(_('Some dependencies are not installed')).removeClass('process').addClass('error');
                setTimeout(function () {
                    step3_processInstances(instances, errors, callback)
                }, 0);
                return;
            }

            step3_processInstance(task, function (err) {
                if (err) errors.push(task._id);

                setTimeout(function () {
                    step3_processInstances(instances, errors, callback)
                }, 0);
            });
        }

        function step3() {
            var text = '';
            var instances = [];
            showConfig = [];
            $('#step3_prev').addClass('disabled');
            var $details = $('#step3_show_details');

            if (!$details.data('inited')) {
                $details.data('inited', true);
                $details.off('click').on('click', function () {
                    var val;
                    if ($stdout.is(':visible')) {
                        $stdout.hide();
                        val = false;
                    } else {
                        $stdout.show();
                        val = true;
                    }
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('wizard.details', val);
                    }
                });
                if (typeof Storage !== 'undefined') {
                    if (localStorage.getItem('wizard.details') === 'true') {
                        $details.trigger('click');
                    }
                }

                var $dialog = $('#dialog-parameters');
                $dialog.modal({
                    dismissible: false
                });

                $dialog.find('.btn-set').off('click').on('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var $dialog = $('#dialog-parameters');
                    var obj = $dialog.data('obj');
                    var error = false;
                    $dialog.find('.params').each(function () {
                        var name = $(this).data('name');
                        var val;
                        if ($(this).attr('type') === 'checkbox') {
                            val = $(this).prop('checked');
                        } else {
                            val = $(this).val();
                        }
                        if ($(this).prop('type') === 'password') {
                            if (val !== $dialog.find('.passRepeat[data-name="' + name + '"]').val()) {
                                showMessage(_('Passwords does not match'), _('Error'), 'alert');
                                error = true;
                                return;
                            }
                        }
                        if ($(this).data('required') && !val) {
                            showMessage(_('Parameter %s is mandatory!', name));
                            error = true;
                            return;
                        }
                        setParam(name, obj, val);
                    });
                    if (!error) {
                        $dialog.modal('close');
                        var callback = $dialog.data('callback');
                        if (callback && typeof callback === 'function') {
                            $dialog.data('callback', null);
                            $dialog.data('obj', null);
                            callback(null, obj);
                        }
                    }
                });
                $dialog.find('.btn-cancel').off('click').on('click', function () {
                    var $dialog = $('#dialog-parameters');
                    $dialog.modal('close');
                    var callback = $dialog.data('callback');
                    if (callback && typeof callback === 'function') {
                        $dialog.data('callback', null);
                        callback(null, null);
                    }
                });
            }

            $('.step2-allow').each(function () {
                if ($(this).prop('checked')) {
                    var i = $(this).data('id');
                    instances.push(newInstances[i]);
                    newInstances[i].common.host = $('.step2-host[data-id="' + i + '"]').val() || hosts[0];
                }
            });

            var noInputsNoRequires  = [];
            var inputsNoRequires = [];
            var requires   = [];

            for (var t = 0; t < instances.length; t++) {
                var i = instances[t].comment.license || instances[t].comment.inputs;
                if (!i && !instances[t].comment.required) {
                    noInputsNoRequires.push(instances[t]);
                } else if (!instances[t].comment.required && i) {
                    inputsNoRequires.push(instances[t]);
                } else {
                    requires.push(instances[t]);
                }
            }

            // 1 inputs, no requires
            // 2 no inputs, no requires
            // 3 requires
            // sort requires by number
            requires.sort(function (a, b) {
                if (a.comment.required.length > b.comment.required.length) return 1;
                if (a.comment.required.length < b.comment.required.length) return -1;
                return 0;
            });
            instances = inputsNoRequires.concat(noInputsNoRequires).concat(requires);

            for (var k = 0; k < instances.length; k++) {
                text += '<tr>';
                text += '<td>' + instances[k]._id.substring('system.adapter.'.length) + '</td>';
                text += '<td data-id="' + instances[k]._id + '" class="step3-progress">' + _('create instance') + '</td>';
                text += '</tr>';
            }
            $('#step3_instances').html(text);

            step3_processInstances(instances, [], function () {
                $('#step3_prev').removeClass('disabled');
            });
        }

        function close() {
            if (typeof parent !== 'undefined' && parent) {
                try {
                    if (parent.$iframeDialog && typeof parent.$iframeDialog.close === 'function') {
                        parent.$iframeDialog.close();
                    } else {
                        parent.postMessage('close', '*');
                    }
                } catch (e) {
                    parent.postMessage('close', '*');
                }
            }
        }

        function load(settings, onChange) {
            $('.header').hide();
            // step 0

            $('.btn-next').off('click').on('click', function () {
                showStep(currentStep + 1);
            });

            $('.btn-prev').off('click').on('click', function () {
                showStep(currentStep - 1);
            });

            $('.btn-close').off('click').on('click', function () {
                if (typeof parent !== 'undefined' && parent) {
                    try {
                        if (parent.$iframeDialog) {
                            parent.showConfig = JSON.parse(JSON.stringify(showConfig));
                        }
                    } catch (e) {
                        parent.postMessage(JSON.stringify(showConfig), '*');
                    }
                }

                window.close();
                close();
            });

            showStep(0);
            $stdout = $('#stdout');

            socket.emit('subscribe',  'discovery.' + instance + '.*');
            socket.on('stateChange', function (id, state) {
                if (state && state.ack && state.val !== null && state.val !== 'null') {
                    if (id === 'discovery.' + instance + '.devicesProgress') {
                        $('#step1_text').show().find('.text').html(_('Lookup devices') + ' - ' + state.val + '%');
                        $('#step1_progressbar').show().find('.progress .determinate').css({width: state.val + '%'});
                    } else
                    if (id === 'discovery.' + instance + '.servicesProgress') {
                        $('#step1_text').show().find('.text').html(_('Lookup services') + ' - ' + state.val + '%');
                        $('#step1_progressbar').show().find('.progress .determinate').css({width: state.val + '%'});
                    } else
                    if (id === 'discovery.' + instance + '.instancesFound') {
                        $('#step1_result').show().find('.text').html(_('Found services', state.val));
                    } else
                    if (id === 'discovery.' + instance + '.devicesFound') {
                        $('#step1_result').show().find('.text').html(_('Found devices', state.val));
                    }
                    else
                    if (id === 'discovery.' + instance + '.scanRunning') {
                        if (!state.val && !isRunning) {
                            step1();
                        }
                    }
                }
            });

            socket.on('cmdStdout', function (_id, text) {
                if (currentInstallId === _id) {
                    stdout += '\n' + text;
                    $stdout.val(stdout);
                    $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                }
            });

            socket.on('cmdStderr', function (_id, text) {
                if (currentInstallId === _id) {
                    stdout += '\nERROR: ' + text;
                    if ($stdout) {
                        $stdout.val(stdout);
                        $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                    }
                }
            });

            socket.on('cmdExit', function (_id, exitCode) {
                if (currentInstallId === _id) {
                    exitCode = parseInt(exitCode, 10);
                    stdout += '\n' + (exitCode !== 0 ? 'ERROR: ' : '') + 'process exited with code ' + exitCode;
                    if ($stdout) {
                        $stdout.val(stdout);
                        $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                    }
                    if (cmdCallback) {
                        cmdCallback(exitCode);
                        cmdCallback = null;
                    }
                }
            });

            onChange(false);
            M.updateTextFields();
        }

        function save(callback) {
            // do nothing
            callback();
        }

        var steps = [
            step0,
            step1,
            step2,
            step3
        ];
    </script>
    <style>
        .adapter-body {
            height: 100% !important;
            overflow: hidden !important;
        }
        .dialog-config-buttons {
            display: none !important;
        }
        .wizard-page {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .wizard-page h6 {
            margin-top: 0.5rem !important;
            margin-left: 0.5rem !important;
        }
        .wizard-header {
            height: 32px !important;
            line-height: 32px !important;
            position: absolute;
            z-index: 1;
            /*width: calc(100% - 6px - 1rem);
            position: absolute;
            top: 0;
            height: 3rem;
            padding-left: 1rem;*/
        }
        .wizard-content {
            padding-top: 32px;
            /*width: calc(100% - 26px);
            position: absolute;
            top: 3rem;
            height: calc(100% - 6rem - 20px);
            padding: 10px;*/
            height: calc(100% - 125px);
            overflow: auto;
        }
        .wizard-footer {
            /*width: calc(100% - 16px);
            position: absolute;
            bottom: 0;
            height: calc(3rem - 10px);
            padding: 5px;
            background: black;
            text-align: right;*/
        }
        .wizard-table {
            width: 100%;
        }
        .wizard-table th {
            background: #338ce6;
            color: white;
            text-align: left;
            border-radius: 0;
        }
        .wizard-table td {
            border-radius: 0;
        }
        .wizard-table tr:nth-child(even) {
            background: #CCC;
        }
        .step2-instance-suggested {
            background: #56fb5a !important;
            color: white;
        }
        .wizard-table tr:nth-child(even).step2-instance-suggested {
            background: #5ecd5f !important;
            color: black;
        }
        .step2-instance-acknowledged {
            opacity: 0.7;
        }
        .wizard-table tr:nth-child(even).step2-instance-acknowledged {
            opacity: 0.6;
        }
        #step3_instances td, #step3_instances th {
            padding-left: 5px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .warn {
            color: orange;
        }
        .process {
            color: orange;
            font-weight: bold;
        }
        #step1_settings {
            float: left;
        }
        #step1_progressbar .progressbar {
            background: white;
        }
        #step1_help1,
        .header-buttons {
            margin-bottom: 0;
            margin-top: 1rem;
        }

        #step0_save_hint {
            float: right;
            color: #f36767;
            font-size: 18px;
            animation: blinker 2s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        nav i {
            line-height: 38px !important;
        }
        .btn-close,
        .btn-next,
        .btn-discover,
        .btn-save  {
            float: right;
            margin-top: 0.6rem;
        }
        .btn-settings,
        .btn-prev {
            float: left;
            margin-left: 1rem;
            margin-top: 0.6rem;
        }
        .btn-close,
        .btn-discover {
            margin-right: 1rem;
        }
        .btn-next {
            margin-right: 0.5rem;
        }
        .btn-save {
            margin-right: 2rem;
        }
        .wizard-table-use {
            width: 100px;
        }
        .wizard-table-instance {
            width: 10%;
        }
        .wizard-table-host {
            width: 20%;
        }
        .wizard-table-desc {
            width: 70%;
        }
        .wizard-table-ignore {
            width: 100px;
        }
        #stdout {
            font-family: courier, monospace;
            font-size: 11px;
            resize: none;
            height: inherit;
        }

    </style>
</head>
<body>
<div style="width: 100%; height: 100%" id="container" class="m">
    <!-- System settings -->
    <div data-step="0" class="wizard-page" style="display: none">
        <nav class="wizard-header">
            <div class="nav-wrapper">
                <h6 class="translate">System settings</h6>
            </div>
        </nav>
        <div class="wizard-content">
            <div class="row">
                <div class="col s6">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="system_language" class="system-settings value">
                                <option value="en">English</option>
                                <option value="de">Deutsch</option>
                                <option value="ru">русский</option>
                                <option value="pt">Portugues</option>
                                <option value="nl">Nederlands</option>
                                <option value="fr">français</option>
                                <option value="it">Italiano</option>
                                <option value="es">Espanol</option>
                                <option value="pl">polski</option>
                            </select>
                            <label class="translate" for="system_language">System language:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="system_tempUnit" class="system-settings value">
                                <option value="°C">°C</option>
                                <option value="°F">°F</option>
                            </select>
                            <label class="translate" for="system_tempUnit">Temperature units:</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <input type="text" size="5" maxlength="5" id="system_currency" class="system-settings value"/>
                            <label class="translate" for="system_currency">Currency:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="system_dateFormat" class="system-settings value">
                                <option value="DD.MM.YYYY" class="translate">DD.MM.YYYY</option>
                                <option value="DD.MM.YY"   class="translate">DD.MM.YY</option>
                                <option value="DD/MM/YYYY" class="translate">DD/MM/YYYY</option>
                            </select>
                            <label class="translate" for="system_dateFormat">Date format:</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="system_isFloatComma" class="system-settings value">
                                <option value="true"  class="translate">comma (3,14)</option>
                                <option value="false" class="translate">point (3.14)</option>
                            </select>
                            <label class="translate" for="system_isFloatComma">Float divider:</label>
                        </div>
                    </div>
                    <div class="row">

                    </div>
                    <!--div class="row">
                        <div class="col s12 m6">
                            <select id="system_defaultHistory" class="system-settings value">
                            </select>
                            <label class="translate" for="system_defaultHistory">Default history instance:</label>
                        </div>
                        <div class="col s12 m6">
                            <select id="system_activeRepo" class="system-settings value">
                            </select>
                            <label class="translate" for="system_activeRepo">Active repository:</label>
                        </div>
                    </div-->
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="system_country" class="system-settings value">
                                <option value="" class="translate">Please select country</option>
                                <option value="Germany" class="translate">Germany</option>
                                <option value="Austria" class="translate">Austria</option>
                                <option value="Switzerland" class="translate">Switzerland</option>
                                <option value="Russian Federation" class="translate">Russian Federation</option>
                                <option value="Ukraine" class="translate">Ukraine</option>
                                <option value="Belarus" class="translate">Belarus</option>
                                <option value="Afghanistan" class="translate">Afghanistan</option>
                                <option value="Albania" class="translate">Albania</option>
                                <option value="Algeria" class="translate">Algeria</option>
                                <option value="American Samoa" class="translate">American Samoa</option>
                                <option value="Andorra" class="translate">Andorra</option>
                                <option value="Angola" class="translate">Angola</option>
                                <option value="Anguilla" class="translate">Anguilla</option>
                                <option value="Antarctica" class="translate">Antarctica</option>
                                <option value="Antigua and Barbuda" class="translate">Antigua and Barbuda</option>
                                <option value="Argentina" class="translate">Argentina</option>
                                <option value="Armenia" class="translate">Armenia</option>
                                <option value="Aruba" class="translate">Aruba</option>
                                <option value="Australia" class="translate">Australia</option>
                                <option value="Azerbaijan" class="translate">Azerbaijan</option>
                                <option value="Bahamas" class="translate">Bahamas</option>
                                <option value="Bahrain" class="translate">Bahrain</option>
                                <option value="Bangladesh" class="translate">Bangladesh</option>
                                <option value="Barbados" class="translate">Barbados</option>
                                <option value="Belgium" class="translate">Belgium</option>
                                <option value="Belize" class="translate">Belize</option>
                                <option value="Benin" class="translate">Benin</option>
                                <option value="Bermuda" class="translate">Bermuda</option>
                                <option value="Bhutan" class="translate">Bhutan</option>
                                <option value="Bolivia" class="translate">Bolivia</option>
                                <option value="Bosnia and Herzegovina" class="translate">Bosnia and Herzegovina</option>
                                <option value="Botswana" class="translate">Botswana</option>
                                <option value="Bouvet Island" class="translate">Bouvet Island</option>
                                <option value="Brazil" class="translate">Brazil</option>
                                <option value="British Indian Ocean Territory" class="translate">British Indian Ocean Territory</option>
                                <option value="Brunei Darussalam" class="translate">Brunei Darussalam</option>
                                <option value="Bulgaria" class="translate">Bulgaria</option>
                                <option value="Burkina Faso" class="translate">Burkina Faso</option>
                                <option value="Burundi" class="translate">Burundi</option>
                                <option value="Cambodia" class="translate">Cambodia</option>
                                <option value="Cameroon" class="translate">Cameroon</option>
                                <option value="Canada" class="translate">Canada</option>
                                <option value="Cape Verde" class="translate">Cape Verde</option>
                                <option value="Cayman Islands" class="translate">Cayman Islands</option>
                                <option value="Central African Republic" class="translate">Central African Republic</option>
                                <option value="Chad" class="translate">Chad</option>
                                <option value="Chile" class="translate">Chile</option>
                                <option value="China" class="translate">China</option>
                                <option value="Christmas Island" class="translate">Christmas Island</option>
                                <option>Cocos (Keeling) Islands</option>
                                <option value="Colombia" class="translate">Colombia</option>
                                <option value="Comoros" class="translate">Comoros</option>
                                <option value="Congo" class="translate">Congo</option>
                                <option value="Cook Islands" class="translate">Cook Islands</option>
                                <option value="Costa Rica" class="translate">Costa Rica</option>
                                <option>Croatia (Hrvatska)</option>
                                <option value="Cuba" class="translate">Cuba</option>
                                <option value="Cyprus" class="translate">Cyprus</option>
                                <option value="Czech Republic" class="translate">Czech Republic</option>
                                <option value="Denmark" class="translate">Denmark</option>
                                <option value="Djibouti" class="translate">Djibouti</option>
                                <option value="Dominica" class="translate">Dominica</option>
                                <option value="Dominican Republic" class="translate">Dominican Republic</option>
                                <option value="East Timor" class="translate">East Timor</option>
                                <option value="Ecuador" class="translate">Ecuador</option>
                                <option value="Egypt" class="translate">Egypt</option>
                                <option value="El Salvador" class="translate">El Salvador</option>
                                <option value="Equatorial Guinea" class="translate">Equatorial Guinea</option>
                                <option value="Eritrea" class="translate">Eritrea</option>
                                <option value="Estonia" class="translate">Estonia</option>
                                <option value="Ethiopia" class="translate">Ethiopia</option>
                                <option>Falkland Islands (Malvinas)</option>
                                <option value="Faroe Islands" class="translate">Faroe Islands</option>
                                <option value="Fiji" class="translate">Fiji</option>
                                <option value="Finland" class="translate">Finland</option>
                                <option value="France" class="translate">France</option>
                                <option>France, Metropolitan</option>
                                <option value="French Guiana" class="translate">French Guiana</option>
                                <option value="French Polynesia" class="translate">French Polynesia</option>
                                <option value="French Southern Territories" class="translate">French Southern Territories</option>
                                <option value="Gabon" class="translate">Gabon</option>
                                <option value="Gambia" class="translate">Gambia</option>
                                <option value="Georgia" class="translate">Georgia</option>
                                <option value="Ghana" class="translate">Ghana</option>
                                <option value="Gibraltar" class="translate">Gibraltar</option>
                                <option value="Guernsey" class="translate">Guernsey</option>
                                <option value="Greece" class="translate">Greece</option>
                                <option value="Greenland" class="translate">Greenland</option>
                                <option value="Grenada" class="translate">Grenada</option>
                                <option value="Guadeloupe" class="translate">Guadeloupe</option>
                                <option value="Guam" class="translate">Guam</option>
                                <option value="Guatemala" class="translate">Guatemala</option>
                                <option value="Guinea" class="translate">Guinea</option>
                                <option>Guinea-Bissau</option>
                                <option value="Guyana" class="translate">Guyana</option>
                                <option value="Haiti" class="translate">Haiti</option>
                                <option value="Heard and Mc Donald Islands" class="translate">Heard and Mc Donald Islands</option>
                                <option value="Honduras" class="translate">Honduras</option>
                                <option value="Hong Kong" class="translate">Hong Kong</option>
                                <option value="Hungary" class="translate">Hungary</option>
                                <option value="Iceland" class="translate">Iceland</option>
                                <option value="India" class="translate">India</option>
                                <option value="Isle of Man" class="translate">Isle of Man</option>
                                <option value="Indonesia" class="translate">Indonesia</option>
                                <option>Iran (Islamic Republic of)</option>
                                <option value="Iraq" class="translate">Iraq</option>
                                <option value="Ireland" class="translate">Ireland</option>
                                <option value="Israel" class="translate">Israel</option>
                                <option value="Italy" class="translate">Italy</option>
                                <option value="Ivory Coast" class="translate">Ivory Coast</option>
                                <option value="Jersey" class="translate">Jersey</option>
                                <option value="Jamaica" class="translate">Jamaica</option>
                                <option value="Japan" class="translate">Japan</option>
                                <option value="Jordan" class="translate">Jordan</option>
                                <option value="Kazakhstan" class="translate">Kazakhstan</option>
                                <option value="Kenya" class="translate">Kenya</option>
                                <option value="Kiribati" class="translate">Kiribati</option>
                                <option>Korea, Democratic People''s Republic of</option>
                                <option>Korea, Republic of</option>
                                <option value="Kosovo" class="translate">Kosovo</option>
                                <option value="Kuwait" class="translate">Kuwait</option>
                                <option value="Kyrgyzstan" class="translate">Kyrgyzstan</option>
                                <option>Lao People''s Democratic Republic</option>
                                <option value="Latvia" class="translate">Latvia</option>
                                <option value="Lebanon" class="translate">Lebanon</option>
                                <option value="Lesotho" class="translate">Lesotho</option>
                                <option value="Liberia" class="translate">Liberia</option>
                                <option value="Libyan Arab Jamahiriya" class="translate">Libyan Arab Jamahiriya</option>
                                <option value="Liechtenstein" class="translate">Liechtenstein</option>
                                <option value="Lithuania" class="translate">Lithuania</option>
                                <option value="Luxembourg" class="translate">Luxembourg</option>
                                <option value="Macau" class="translate">Macau</option>
                                <option value="Macedonia" class="translate">Macedonia</option>
                                <option value="Madagascar" class="translate">Madagascar</option>
                                <option value="Malawi" class="translate">Malawi</option>
                                <option value="Malaysia" class="translate">Malaysia</option>
                                <option value="Maldives" class="translate">Maldives</option>
                                <option value="Mali" class="translate">Mali</option>
                                <option value="Malta" class="translate">Malta</option>
                                <option value="Marshall Islands" class="translate">Marshall Islands</option>
                                <option value="Martinique" class="translate">Martinique</option>
                                <option value="Mauritania" class="translate">Mauritania</option>
                                <option value="Mauritius" class="translate">Mauritius</option>
                                <option value="Mayotte" class="translate">Mayotte</option>
                                <option value="Mexico" class="translate">Mexico</option>
                                <option>Micronesia, Federated States of</option>
                                <option>Moldova, Republic of</option>
                                <option value="Monaco" class="translate">Monaco</option>
                                <option value="Mongolia" class="translate">Mongolia</option>
                                <option value="Montenegro" class="translate">Montenegro</option>
                                <option value="Montserrat" class="translate">Montserrat</option>
                                <option value="Morocco" class="translate">Morocco</option>
                                <option value="Mozambique" class="translate">Mozambique</option>
                                <option value="Myanmar" class="translate">Myanmar</option>
                                <option value="Namibia" class="translate">Namibia</option>
                                <option value="Nauru" class="translate">Nauru</option>
                                <option value="Nepal" class="translate">Nepal</option>
                                <option value="Netherlands" class="translate">Netherlands</option>
                                <option value="Netherlands Antilles" class="translate">Netherlands Antilles</option>
                                <option value="New Caledonia" class="translate">New Caledonia</option>
                                <option value="New Zealand" class="translate">New Zealand</option>
                                <option value="Nicaragua" class="translate">Nicaragua</option>
                                <option value="Niger" class="translate">Niger</option>
                                <option value="Nigeria" class="translate">Nigeria</option>
                                <option value="Niue" class="translate">Niue</option>
                                <option value="Norfolk Island" class="translate">Norfolk Island</option>
                                <option value="Northern Mariana Islands" class="translate">Northern Mariana Islands</option>
                                <option value="Norway" class="translate">Norway</option>
                                <option value="Oman" class="translate">Oman</option>
                                <option value="Pakistan" class="translate">Pakistan</option>
                                <option value="Palau" class="translate">Palau</option>
                                <option value="Palestine" class="translate">Palestine</option>
                                <option value="Panama" class="translate">Panama</option>
                                <option value="Papua New Guinea" class="translate">Papua New Guinea</option>
                                <option value="Paraguay" class="translate">Paraguay</option>
                                <option value="Peru" class="translate">Peru</option>
                                <option value="Philippines" class="translate">Philippines</option>
                                <option value="Pitcairn" class="translate">Pitcairn</option>
                                <option value="Poland" class="translate">Poland</option>
                                <option value="Portugal" class="translate">Portugal</option>
                                <option value="Puerto Rico" class="translate">Puerto Rico</option>
                                <option value="Qatar" class="translate">Qatar</option>
                                <option value="Reunion" class="translate">Reunion</option>
                                <option value="Romania" class="translate">Romania</option>
                                <option value="Rwanda" class="translate">Rwanda</option>
                                <option value="Saint Kitts and Nevis" class="translate">Saint Kitts and Nevis</option>
                                <option value="Saint Lucia" class="translate">Saint Lucia</option>
                                <option value="Saint Vincent and the Grenadines" class="translate">Saint Vincent and the Grenadines</option>
                                <option value="Samoa" class="translate">Samoa</option>
                                <option value="San Marino" class="translate">San Marino</option>
                                <option value="Sao Tome and Principe" class="translate">Sao Tome and Principe</option>
                                <option value="Saudi Arabia" class="translate">Saudi Arabia</option>
                                <option value="Senegal" class="translate">Senegal</option>
                                <option value="Serbia" class="translate">Serbia</option>
                                <option value="Seychelles" class="translate">Seychelles</option>
                                <option value="Sierra Leone" class="translate">Sierra Leone</option>
                                <option value="Singapore" class="translate">Singapore</option>
                                <option value="Slovakia" class="translate">Slovakia</option>
                                <option value="Slovenia" class="translate">Slovenia</option>
                                <option value="Solomon Islands" class="translate">Solomon Islands</option>
                                <option value="Somalia" class="translate">Somalia</option>
                                <option value="South Africa" class="translate">South Africa</option>
                                <option value="South Georgia South Sandwich Islands" class="translate">South Georgia South Sandwich Islands</option>
                                <option value="Spain" class="translate">Spain</option>
                                <option value="Sri Lanka" class="translate">Sri Lanka</option>
                                <option>St. Helena</option>
                                <option>St. Pierre and Miquelon</option>
                                <option value="Sudan" class="translate">Sudan</option>
                                <option value="Suriname" class="translate">Suriname</option>
                                <option value="Svalbard and Jan Mayen Islands" class="translate">Svalbard and Jan Mayen Islands</option>
                                <option value="Swaziland" class="translate">Swaziland</option>
                                <option value="Sweden" class="translate">Sweden</option>
                                <option value="Syrian Arab Republic" class="translate">Syrian Arab Republic</option>
                                <option value="Taiwan" class="translate">Taiwan</option>
                                <option value="Tajikistan" class="translate">Tajikistan</option>
                                <option>Tanzania, United Republic of</option>
                                <option value="Thailand" class="translate">Thailand</option>
                                <option value="Togo" class="translate">Togo</option>
                                <option value="Tokelau" class="translate">Tokelau</option>
                                <option value="Tonga" class="translate">Tonga</option>
                                <option value="Trinidad and Tobago" class="translate">Trinidad and Tobago</option>
                                <option value="Tunisia" class="translate">Tunisia</option>
                                <option value="Turkey" class="translate">Turkey</option>
                                <option value="Turkmenistan" class="translate">Turkmenistan</option>
                                <option value="Turks and Caicos Islands" class="translate">Turks and Caicos Islands</option>
                                <option value="Tuvalu" class="translate">Tuvalu</option>
                                <option value="Uganda" class="translate">Uganda</option>
                                <option value="United Arab Emirates" class="translate">United Arab Emirates</option>
                                <option value="United Kingdom" class="translate">United Kingdom</option>
                                <option value="United States" class="translate">United States</option>
                                <option value="United States minor outlying islands" class="translate">United States minor outlying islands</option>
                                <option value="Uruguay" class="translate">Uruguay</option>
                                <option value="Uzbekistan" class="translate">Uzbekistan</option>
                                <option value="Vanuatu" class="translate">Vanuatu</option>
                                <option value="Vatican City State" class="translate">Vatican City State</option>
                                <option value="Venezuela" class="translate">Venezuela</option>
                                <option value="Vietnam" class="translate">Vietnam</option>
                                <option>Virgin Islands (British)</option>
                                <option>Virgin Islands (U.S.)</option>
                                <option value="Wallis and Futuna Islands" class="translate">Wallis and Futuna Islands</option>
                                <option value="Western Sahara" class="translate">Western Sahara</option>
                                <option value="Yemen" class="translate">Yemen</option>
                                <option value="Zaire" class="translate">Zaire</option>
                                <option value="Zambia" class="translate">Zambia</option>
                                <option value="Zimbabwe" class="translate">Zimbabwe</option>
                            </select>
                            <label class="translate" for="system_country">Country:</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <input id="system_city" type="text" class="system-settings value"/>
                            <label class="translate" for="system_city">City:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s8">
                            <input id="system_address" type="text" />
                            <label class="translate" for="system_address">Address:</label>
                        </div>
                        <div class="col s4">
                            <a id="detectCoordinates" class="waves-effect waves-light btn-floating translateT" title="Find coordinates..."><i class="material-icons left">location_searching</i></a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <input id="system_latitude" type="text" class="system-settings value" />
                            <label class="translate" for="system_latitude">Latitude:</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <input id="system_longitude" type="text" class="system-settings value" />
                            <label class="translate" for="system_longitude">Longitude:</label>
                        </div>
                    </div>
                </div>
                <div class="col s6">
                    <div id="step0_map" style="width: 100%; height: 100%"></div>
                </div>
            </div>

        </div>
        <nav class="wizard-footer nav-wrapper footer">
            <a id="step0_close" class="btn btn-close">
                <i class="material-icons left">close</i>
                <span class="translate">Close</span>
            </a>
            <a id="step0_next" class="btn btn-next btn-active">
                <i class="material-icons left">navigate_next</i>
                <span class="translate">Next</span>
            </a>
            <a id="step0_save" class="btn btn-save">
                <i class="material-icons left">save</i>
                <span class="translate">Save</span>
            </a>
            <div id="step0_save_hint" class="translate">save-hint</div>
        </nav>
    </div>
    <!-- Discover all possible devices -->
    <div data-step="1" class="wizard-page" style="display: none">
        <nav class="wizard-header">
            <div class="nav-wrapper">
                <h6 class="translate">Discover all possible devices</h6>
            </div>
        </nav>
        <div class="wizard-content">
            <div class="row" id="step1_help1">
                <div class="col s12 text translate">step1_help1</div>
            </div>
            <div class="row"  id="step1_help2" style="display: none">
                <div class="col s12 translate text">step1_help2</div>
            </div>
            <div class="row" id="step1_help3" style="display: none">
                <div class="col s12 translate text"></div>
            </div>
            <div class="row" id="step1_methods" style="display: none" >
                <div class="col s12 text"></div>
            </div>
            <div class="row" id="step1_text" style="display: none">
                <div class="col s12 text" ></div>
            </div>
            <div class="row" id="step1_progressbar" style="display: none">
                <div class="col s12" >
                    <div class="progress">
                        <div class="determinate" style="width: 70%"></div>
                    </div>
                </div>
            </div>
            <div class="row" id="step1_result"  style="display: none">
                <div class="col s12 text"></div>
            </div>
        </div>
        <nav class="wizard-footer nav-wrapper footer">
            <a id="step1_close"    class="btn btn-close">
                <i class="material-icons left">close</i>
                <span class="translate">Close</span>
            </a>
            <a id="step1_next"     class="btn btn-next">
                <i class="material-icons left">navigate_next</i>
                <span class="translate">Next</span>
            </a>
            <a id="step1_prev"     class="btn btn-prev">
                <i class="material-icons left">navigate_before</i>
                <span class="translate">Back</span>
            </a>
            <a id="step1_discover" class="btn btn-discover btn-active">
                <i class="material-icons left">visibility</i>
                <span class="translate">Discover</span>
            </a>
            <a id="step1_settings" class="btn btn-settings">
                <i class="material-icons left">build</i>
                <span class="translate">Settings</span>
            </a>
        </nav>
    </div>
    <!-- Create instances automatically -->
    <div data-step="2" class="wizard-page" style="display: none">
        <nav class="wizard-header">
            <div class="nav-wrapper">
                <h6 class="translate" id="step2_header">Create instances automatically</h6>
            </div>
        </nav>
        <div class="wizard-content">
            <div class="row header-buttons">
                <div class="col s12">
                    <a class="btn" id="step2_selectall">
                        <i class="material-icons left">done_all</i>
                        <span class="translate">Select all</span>
                    </a>
                    <a class="btn" id="step2_deselectall">
                        <i class="material-icons left">do_not_disturb_alt</i>
                        <span class="translate">Deselect all</span>
                    </a>
                    <a class="btn" id="step2-show-acknowledged">
                        <i class="material-icons left">expand_more</i>
                        <span class="translate">Show all</span>
                    </a>
                    <a class="btn" id="step2-show-suggested">
                        <i class="material-icons left">arrow_drop_down_circle</i>
                        <span class="translate">Show suggested too</span>
                    </a>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <table class="wizard-table">
                        <thead>
                        <tr>
                            <th class="translate wizard-table-use">Use</th>
                            <th class="translate wizard-table-instance">Instance</th>
                            <th class="translate wizard-table-host">Host</th>
                            <th class="translate wizard-table-desc">Description</th>
                            <th class="translate wizard-table-ignore translateT" title="Do not show this instance any more">Ignore</th>
                        </tr>
                        </thead>
                        <tbody id="step2_instances">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <nav class="wizard-footer nav-wrapper footer">
            <a id="step2_close"    class="btn btn-close">
                <i class="material-icons left">close</i>
                <span class="translate">Close</span>
            </a>
            <a id="step2_prev"     class="btn btn-prev">
                <i class="material-icons left">navigate_before</i>
                <span class="translate">Back</span>
            </a>
            <a id="step2_next"  class="btn btn-next active">
                <i class="material-icons left">navigate_next</i>
                <span class="translate">Create instances</span>
            </a>
        </nav>
    </div>
    <!-- Install adapters -->
    <div data-step="3" class="wizard-page" style="display: none">
        <nav class="wizard-header">
            <div class="nav-wrapper">
                <h6 class="translate">Install adapters</h6>
            </div>
        </nav>
        <div class="wizard-content">
            <div class="row">
                <div class="col s12">
                    <table class="wizard-table">
                        <thead>
                        <tr>
                            <th class="translate" style="width: 200px">Instance</th>
                            <th class="translate">Progress</th>
                        </tr>
                        </thead>
                        <tbody id="step3_instances">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col s12 l2">
                    <div class="switch">
                        <label>
                            <span class="translate">less</span>
                            <input id="step3_show_details" type="checkbox">
                            <span class="lever"></span>
                            <span class="translate">more</span>
                        </label>
                    </div>
                </div>
                <div class="col s12 l10">
                    <textarea style="display: none" id="stdout" disabled="disabled" cols="120" rows="10"></textarea>
                </div>
            </div>
        </div>
        <nav class="wizard-footer nav-wrapper footer">
            <a id="step3_prev"     class="btn btn-prev">
                <i class="material-icons left">navigate_before</i>
                <span class="translate">Back</span>
            </a>
            <a id="step3_close" class="btn btn-close btn-active">
                <i class="material-icons left">close</i>
                <span class="translate">Finish</span>
            </a>
        </nav>
    </div>
</div>

<div class="material-dialogs m">
    <div id="dialog-license" class="modal modal-fixed-footer" style="display: none">
        <div class="modal-content">
            <div class="col s12 m6 l3">
                <h5 class="translate" id="license_agreement_label">license agreement</h5>
            </div>
            <div class="row">
                <div class="col s12">
                    <div id="license_text"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a id="license_agree"     class="modal-action modal-close waves-effect waves-green btn-flat translate">agree</a>
            <a id="license_non_agree" class="modal-action modal-close waves-effect waves-green btn-flat btn-gray translate">not agree</a>
        </div>
    </div>

    <div id="dialog-parameters" style="display: none; z-index: 102" class="modal modal-fixed-footer">
        <div class="modal-content">
            <div class="row">
                <div class="col s12">
                    <h6 class="title"></h6>
                </div>
            </div>
            <div class="row">
                <div class="col s12 controls">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a class="modal-action modal-close waves-effect waves-green btn btn-set"  ><i class="large material-icons">check</i><span class="translate">Apply</span></a>
            <a class="modal-action modal-close waves-effect waves-green btn btn-close"><i class="large material-icons">close</i><span class="translate">Close</span></a>
        </div>
    </div>

</div>
</body>
</html>