<html>
<head>
    <link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
    <script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>


    <link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="words.js"></script>
    <script type="text/javascript">
        function showStep(step) {
            currentStep = step;
            if (steps[step]) steps[step]();
            var $container = $('#container');
            $container.find('.wizard-page').hide();
            $('.wizard-page[data-step="' + step + '"]').show();
        }
        var currentStep = null;
        var newInstances;
        //var existingInstances;
        var devices;
        var repos = {};
        var hosts = [];

        var currentInstallId;
        var $stdout = null;
        var stdout = '';
        var cmdCallback = null;

        function step0() {
            var $step0 = $('#step0_discover');
            $('#step0_help1').show();
            $('#step0_text').hide();
            $('#step0_progressbar').hide();

            var $settings = $('#step0_settings');
            $settings.button({
                label:  _($settings.data('title')),
                icons: {
                    primary: ' ui-icon-pencil'
                }
            }).unbind('click').click(function () {
                document.location = 'settings.html' + document.location.search;
            });

            $step0.button({
                label:  _($step0.data('title')),
                icons: {
                    primary: ' ui-icon-search'
                }
            }).unbind('click').click(function () {
                $step0.button('disable');
                $('#step0_next').button('disable');
                $('#step0_help1').hide();
                $('#step0_help2').hide();

                sendTo(null, 'browse', null, function (result) {
                    $('#step0_text').hide();
                    $('#step0_progressbar').hide();
                    $('#step0_next').button('enable');
                    $step0.button('enable');
                    if (result.error) {
                        showMessage(result.error, _('Error'), 'alert');
                    } else {
                        newInstances = result.newInstances;
                        devices = result.devices;
                        showStep(currentStep + 1);
                    }
                });
            });

            $('#step0_next').button('disable');
            $('#step0_help2').hide();

            getIsAdapterAlive(function (isAlive) {
                if (!isAlive) {
                    $step0.button('disable');
                }
            });

            socket.emit('getObject', 'system.discovery', function (err, obj) {
                if (obj && obj.native.newInstances) {
                    newInstances = obj.native.newInstances;
                }
                if (obj && obj.native.devices) {
                    devices = obj.native.devices;
                }
                var found = false;
                if (devices) {
                    for (var d in devices) {
                        if (devices.hasOwnProperty(d)) {
                            found = true;
                            break;
                        }
                    }
                }
                if (newInstances) {
                    for (var n in newInstances) {
                        if (newInstances.hasOwnProperty(n)) {
                            found = true;
                            break;
                        }
                    }
                }
                if (found) {
                    $('#step0_next').button('enable');
                    $('#step0_help2').show();
                }
            });
        }

        function getExistingInstances(callback) {
            socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.', endkey: 'system.adapter.\u9999'}, function (err, doc) {
                if (err) {
                    if (callback) callback ([]);
                } else {
                    if (doc.rows.length === 0) {
                        if (callback) callback ([]);
                    } else {
                        var res = [];
                        for (var i = 0; i < doc.rows.length; i++) {
                            res.push(doc.rows[i].value);
                        }
                        if (callback) callback (res);
                    }
                }
            });
        }

        function buildComment(comment) {
            if (!comment) {
                return _('new');
            }
            if (typeof comment === 'string') return comment;
            var text = '';
            if (comment.add) {
                text += _('new');
                if (typeof comment.add === 'object' &&  + comment.add.length !== undefined) {
                    text += ': ';
                    if (comment.add.length <= 5) {
                        text += comment.add.join(', ');
                    } else {
                        text += _('%s devices', comment.add.length);
                    }
                } else if (typeof comment.add === 'string' || typeof comment.add === 'number') {
                    text += ': ';
                    text += comment.add;
                }
            }
            if (comment.changed) {
                text += (text ? ', ' : '') + _('changed');
                if (typeof comment.changed === 'object' &&  + comment.changed.length !== undefined) {
                    text += ': ';
                    if (comment.changed.length <= 5) {
                        text += comment.changed.join(', ');
                    } else {
                        text += _('%s devices', comment.changed.length);
                    }
                } else if (typeof comment.changed === 'string' || typeof comment.changed === 'number') {
                    text += ': ';
                    text += comment.changed;
                }
            }
            if (comment.extended) {
                text += (text ? ', ' : '') + _('extended');
                if (typeof comment.extended === 'object' &&  + comment.extended.length !== undefined) {
                    text += ': ';
                    if (comment.extended.length <= 5) {
                        text += comment.extended.join(', ');
                    } else {
                        text += _('%s devices', comment.extended.length);
                    }
                } else if (typeof comment.extended === 'string' || typeof comment.extended === 'number') {
                    text += ': ';
                    text += comment.extended;
                }
            }
            if (comment.text) {
                text += (text ? ', ' : '') + comment.text;
            }
            return text;
        }

        function disableDependencies(id) {
            var recheck = false;
            // disable all that depends on it
            for (var ii = 0; ii < newInstances.length; ii++) {
                if (newInstances[ii].comment.required && newInstances[ii].comment.required.indexOf(id) !== -1) {
                    var $check = $('.step1-allow[data-id="' + ii + '"]');
                    if ($check.prop('checked')) {
                        $check.prop('checked', false);
                        recheck = true;
                        disableDependencies(newInstances[ii]._id);
                    }
                }
            }
            return recheck;
        }
        function step1CheckNextAllow() {
            var allow = false;
            var $allow = $('.step1-allow');
            var recheck = false;
            var index = $(this).data('id');
            if ($(this).prop('checked')) {
                if (newInstances[index].comment && newInstances[index].comment.required) {
                    if (typeof newInstances[index].comment.required === 'string') newInstances[index].comment.required = [newInstances[index].comment.required];
                    for (var r = 0; r < newInstances[index].comment.required.length; r++) {
                        for (var i = 0; i < newInstances.length; i++) {
                            if (newInstances[i]._id === newInstances[index].comment.required[r]) {
                                $('.step1-allow[data-id="' + i + '"]').prop('checked', true);
                            }
                        }
                    }
                }
            } else {
                // disable all that depends on it
                disableDependencies(newInstances[index]._id);
            }

            $allow.each(function () {
                if ($(this).prop('checked')) {
                    allow = true;
                    return false;
                }
            });
            if (allow) {
                $('#step1_next').button('enable');
            } else {
                $('#step1_next').button('disable');
            }
        }

        function step1_getHosts(callback) {
            if (hosts && hosts.length) {
                return callback(hosts);
            } else {
                socket.emit('getObjectView', 'system', 'host', {startkey: 'system.host.', endkey: 'system.host.\u9999'}, function (err, res) {
                    if (!err && res) {
                        hosts = [];
                        for (var i = 0; i < res.rows.length; i++) {
                            hosts.push(res.rows[i].id.substring('system.host.'.length));
                        }
                    }
                    if (callback) callback(hosts);
                });

            }
        }

        function step1_showHideInstaces() {
            $('.step1-instance').show();

            if (!$('#step1-show-acknowledged').hasClass('discovery-state-active')) {
                $('.step1-instance-acknowledged').hide();
            }
            if (!$('#step1-show-suggested').hasClass('discovery-state-active')) {
                $('.step1-instance-suggested').hide();
            }
        }
        // show list of found instances
        function step1() {
            var $step1_selectall = $('#step1_selectall');
            if (!$step1_selectall.data('inited')) {
                $step1_selectall.data('inited', true);
                $step1_selectall.button({
                    text: false,
                    icons: {
                        primary: 'ui-icon-check'
                    }
                }).unbind('click').click(function () {
                    $('.step1-allow').each(function () {
                        $(this).prop('checked', true);
                    });
                    step1CheckNextAllow();
                }).attr('title', _('Select all'));

                $('#step1_deselectall').button({
                    text: false,
                    icons: {
                        primary: 'ui-icon-minus'
                    }
                }).unbind('click').click(function () {
                    $('.step1-allow').each(function () {
                        $(this).prop('checked', false);
                    });
                    step1CheckNextAllow();
                }).attr('title', _('Deselect all'));



                $('#step1-show-acknowledged').button({
                    label: _('Show not only new'),
                    icons: {
                        primary: 'ui-icon-circle-zoomin'
                    }
                }).click(function () {
                    var isShow = $(this).hasClass('discovery-state-active');
                    if (isShow) {
                        $(this).removeClass('discovery-state-active');
                    } else {
                        $(this).addClass('discovery-state-active');
                    }
                    step1_showHideInstaces();
                    if (typeof storage !== 'undefined') {
                        storage.set('wizard.show.acknowledged', $(this).hasClass('discovery-state-active'));
                    }
                }).attr('title', _('Show all instances'));

                $('#step1-show-suggested').button({
                    label: _('Show not only new'),
                    icons: {
                        primary: 'ui-icon-notice'
                    }
                }).click(function () {
                    var isShow = $(this).hasClass('discovery-state-active');
                    if (isShow) {
                        $(this).removeClass('discovery-state-active');
                    } else {
                        $(this).addClass('discovery-state-active');
                    }
                    step1_showHideInstaces();
                    if (typeof storage !== 'undefined') {
                        storage.set('wizard.show.suggested', $(this).hasClass('discovery-state-active'));
                    }
                }).attr('title', _('Show suggested'));

                if (typeof storage !== 'undefined') {
                    if (storage.get('wizard.show.acknowledged')) {
                        $('#step1-show-acknowledged').addClass('discovery-state-active');
                    }
                    if (storage.get('wizard.show.suggested')) {
                        $('#step1-show-suggested').addClass('discovery-state-active');
                    }
                }
            }

            step1_getHosts(function () {
                var $instances = $('#step1_instances');

                var text = '';
                var hasSuggested = false;
                var hasAcknowledged = false;
                if (newInstances) {
                    for (var i = 0; i < newInstances.length; i++) {
                        if (newInstances[i].comment.ack) hasAcknowledged = true;
                        if (newInstances[i].comment.advice) hasSuggested = true;

                        text += '<tr data-id="' + i + '" class="step1-instance ' +
                            (newInstances[i].comment.ack ? 'step1-instance-acknowledged' : '') +
                            (newInstances[i].comment.advice ? 'step1-instance-suggested' : '') +
                            '">';
                        text += '<td><input type="checkbox" data-id="' + i + '" class="step1-allow"/></td>';
                        text += '<td>' + newInstances[i]._id.substring('system.adapter.'.length) + '</td>';
                        if (hosts.length > 1) {
                            text += '<td><select class="step1-host" data-id="' + i + '" ' + (newInstances[i].common.host ? 'disabled' : '') + '>';
                            for (var h = 0; h < hosts.length; h++) {
                                text += '<option value="' + hosts[h] + '" ' + (newInstances[i].common.host === hosts[h] ? 'selected' : '') + '>' + hosts[h] + '</option>';
                            }
                            text += '</select></td>';
                        } else {
                            text += '<td><select class="step1-host" data-id="' + i + '" disabled><option value="' + hosts[0] + '" selected>' + hosts[0] + '</option></select></td>';
                        }
                        text += '<td>' + buildComment(newInstances[i].comment) + '</td>';
                        text += '<td><input type="checkbox" data-id="' + i + '" ' + (newInstances[i].comment.ack ? 'disabled checked' : '') + ' class="step1-ack"/></td>';
                        text += '</tr>';
                    }
                }

                $instances.html(text);

                var $acknowledged = $('#step1-show-acknowledged');
                var $suggested    = $('#step1-show-suggested');
                if (!hasAcknowledged) {
                    $acknowledged.hide();
                } else {
                    $acknowledged.show();
                }
                if (!hasSuggested) {
                    $suggested.hide();
                } else {
                    $suggested.show();
                }
                if (!$acknowledged.hasClass('discovery-state-active')) {
                    $('.step1-instance-acknowledged').hide();
                }
                if (!$suggested.hasClass('discovery-state-active')) {
                    $('.step1-instance-suggested').hide();
                }
                $('.step1-allow').change(step1CheckNextAllow);
                $('.step1-ack').change(function () {
                    var isShow = $('.step1-show-acknowledged').hasClass('discovery-state-active');
                    var i = $(this).data('id');
                    newInstances[i].comment.ack = true;
                    var $instance = $('.step1-instance[data-id="' + i + '"]');
                    if (!isShow) $instance.hide();

                    $instance.addClass('step1-instance-acknowledged');

                    socket.emit('getObject', 'system.discovery', function (err, obj) {
                        var found = false;
                        if (obj && obj.native && obj.native.newInstances) {
                            for (var n = 0; n < obj.native.newInstances.length; n++) {
                                if (obj.native.newInstances[n]._id === newInstances[i]._id) {
                                    found = true;
                                    obj.native.newInstances[n].comment.ack = true;
                                    break;
                                }
                            }
                        }
                        if (found) {
                            socket.emit('setObject', 'system.discovery', obj, function (err) {
                                if (err) console.error(err);
                            });
                        } else {
                            showMessage(_('Please close dialog and open it anew!'), _('Unknown error'), 'alert');
                        }
                    });
                });

                step1CheckNextAllow();
            });
        }

        function step2_showLicenseDialog(adapter, callback) {
            var $dialogLicense = $('#dialog-license');

            // Is adapter installed
            if (adapter.installed || !adapter.licenseUrl) {
                callback(true);
                return;
            }
            $('#license_language').hide();
            $('#license_diag').hide();
            $('#license_language_label').hide();
            $('#license_checkbox').hide();

            var timeout = setTimeout(function () {
                timeout = null;
                callback(true);
            }, 10000);

            // Workaround
            // https://github.com/ioBroker/ioBroker.vis/blob/master/LICENSE =>
            // https://raw.githubusercontent.com/ioBroker/ioBroker.vis/master/LICENSE
            if (adapter.licenseUrl.indexOf('github.com') !== -1) {
                adapter.licenseUrl = adapter.licenseUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }

            socket.emit('httpGet', adapter.licenseUrl, function (error, response, body) {
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;

                    if (!error && body) {
                        $dialogLicense.css({'z-index': 200});
                        $('#license_text').html('<pre>' + body + '</pre>');
                        $dialogLicense.dialog({
                            autoOpen: true,
                            modal: true,
                            width: 600,
                            height: 400,
                            open: function (event) {
                                $(event.target).parent().find('.ui-dialog-titlebar-close .ui-button-text').html('');
                            },
                            buttons: [
                                {
                                    text: _('agree'),
                                    click: function () {
                                        $dialogLicense.dialog('close');
                                        callback(true);
                                    }
                                },
                                {
                                    text: _('not agree'),
                                    click: function () {
                                        $dialogLicense.dialog('close');
                                        callback(false);
                                    }
                                }
                            ],
                            close: function () {
                                callback(false);
                            }
                        });
                    } else {
                        callback(true);
                    }
                }
            });
        }

        function step2_waitTillInstalled(id, timeout, callback, count) {
            count = count || 0;

            socket.emit('getState', id, function (err, state) {
                console.log(id + '(' + count + '): ' + (state ? state.val : 'null'));
                if (state && state.val) {
                    callback && callback();
                } else {
                    count++;
                    if (count * 1000 > timeout) {
                        callback && callback('timeout');
                    } else {
                        setTimeout(function () {
                            step2_waitTillInstalled(id, timeout, callback, count + 1);
                        }, 1000);
                    }
                }
            });
        }

        function step2_getAdaptersInfo(host, callback) {
            if (!host) return;

            if (!callback) throw 'Callback cannot be null or undefined';

            if (repos[host]) {
                return callback(repos[host].curRepository, repos[host].curInstalled, host);
            }

            repos[host] = {curRepository: null, curInstalled: null};

            socket.emit('sendToHost', host, 'getRepository', {}, function (_repository) {
                if (_repository === 'permissionError') {
                    console.error('May not read "getRepository"');
                    _repository = {};
                }

                repos[host].curRepository = _repository || {};
                if (repos[host].curRepository && repos[host].curInstalled) {
                    callback(repos[host].curRepository, repos[host].curInstalled, host);
                }
            });

            socket.emit('sendToHost', host, 'getInstalled', null, function (_installed) {
                if (_installed === 'permissionError') {
                    console.error('May not read "getInstalled"');
                    _installed = {};
                }

                repos[host].curInstalled = _installed || {};
                if (repos[host].curRepository && repos[host].curInstalled) {
                    callback(repos[host].curRepository, repos[host].curInstalled, host);
                }
            });
        }

        function step2_getAdapterInfo(host, name, callback) {
            socket.emit('sendToHost', host, 'getInstalledAdapter', name, callback);
        }

        function step2_addInstance(template, obj, callback) {
            template._id = obj._id;
            template.common.enabled = true;
            template.type = 'instance';
            template.comment = obj.comment;

            for (var c in obj.common) {
                if (obj.common.hasOwnProperty(c)) template.common[c] = obj.common[c];
            }
            for (var n in obj.native) {
                if (obj.native.hasOwnProperty(n)) template.native[n] = obj.native[n];
            }
            var $text = $('.step2-progress[data-id="' + obj._id + '"]');
            $text.html(_('check parameters')).addClass('warn');
            step2_askParameters(template, function (err, template) {
                if (!template) {
                    $text.html(_('canceled')).addClass('warn');
                    callback && callback();
                    return;
                }
                $text.html(_('wait till installed')).addClass('warn');
                template = JSON.parse(JSON.stringify(template));
                if (template.comment) delete template.comment;

                socket.emit('setObject', template._id, template, function (err) {
                    step2_waitTillInstalled(obj._id + '.alive', 20000, function (err) {
                        if (err) {
                            $text.html(_('timeout by install')).addClass('error');
                            callback && callback();
                        } else {
                            // Remove it from list
                            socket.emit('getObject', 'system.discovery', function (err, discObj) {
                                var changed = false;
                                if (discObj && discObj.native.newInstances) {
                                    // remove obj.native.newInstances
                                    for (var i = 0; i < discObj.native.newInstances.length; i++) {
                                        if (template._id === discObj.native.newInstances[i]._id) {
                                            discObj.native.newInstances.splice(i, 1);
                                            changed = true;
                                            break;
                                        }
                                    }
                                }
                                if (changed) {
                                    newInstances = discObj.native.newInstances;
                                    socket.emit('setObject', 'system.discovery', discObj, function (err) {
                                        $text.html(_('started')).addClass('success').removeClass('warn');
                                        callback && callback();
                                    });
                                } else {
                                    $text.html(_('started')).addClass('success').removeClass('warn');
                                    callback && callback();
                                }
                            });
                        }
                    });
                });
            });
        }

        function getParam(name, obj) {
            var parts = name.split('.');
            do {
                var attr = parts.shift();
                if (typeof obj === 'object') {
                    obj = obj[attr];
                } else {
                    obj = undefined;
                    break;
                }
            } while (parts.length);

            return obj;
        }

        function setParam(name, obj, value) {
            var parts = name.split('.');
            if (parts.length === 1) {
                obj[name] = value;
                return;
            }

            do {
                var attr = parts.shift();
                if (!parts.length) {
                    obj[attr] = value;
                    break;
                }
                if (typeof obj === 'object') {
                    obj = obj[attr];
                } else {
                    obj = {};
                    break;
                }
            } while (parts.length);
        }

        function step2_askParameters(obj, callback) {
            if (obj.comment && obj.comment.inputs) {
                // check if all required parameters are set
                var params = [];
                for (var p = 0; p < obj.comment.inputs.length; p++) {
                    var name = obj.comment.inputs[p].name;
                    var val = getParam(obj.comment.inputs[p].name, obj);
                    if (val === undefined || val === obj.comment.inputs[p].def) {
                        params.push(obj.comment.inputs[p]);
                    }
                }

                if (params.length) {
                    var text = '<table>';
                    var text = '<tr class="param-line"><td>' + _('Description') + '</td><td>' + buildComment(obj.comment) + '</td></tr>';

                    for (var pp = 0; pp < params.length; pp++) {
                        text += '<tr class="param-line">';
                        text += '<td>' + _(params[pp].title) + ': </td><td>';
                        if (params[pp].type === 'password') {
                            text += '<input data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="params" type="password"/></td>';
                            text += '</tr><tr class="param-line"><td>' + _('passwordRepeat') + '</td>';
                            text += '<td><input data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="passRepeat" type="password"/>';
                        } else if (params[pp].type === 'checkbox') {
                            text += '<input data-name="' + params[pp].name + '" type="checkbox" ' + (params[pp].def ? 'checked' : '') + ' class="params" />';
                        } else if (params[pp].type === 'select') {
                            text += '<select data-name="' + params[pp].name + '" class="params">';
                            for (var op in params[pp].options) {
                                if (!params[pp].options.hasOwnProperty(op)) continue;
                                text += '<option value="' + op + '" ' + (params[pp].def === op ? 'selected' : '') + '>' + (params[pp].options[op] || op) + '</option>';
                            }
                            text += '</select>';
                        } else{
                            text += '<input data-name="' + params[pp].name + '" value="' + (params[pp].def !== undefined ? params[pp].def : '') + '" class="params" />';
                        }
                        text += '</td></tr>';
                    }
                    text += '</table>';
                    var $dialog = $('#dialog-parameters');
                    $dialog.html(text);
                    $dialog.dialog('option', 'title', _('Edit parameters for %s', obj._id.substring('system.adapter.'.length)));
                    //$dialog.dialog('option', 'height', 150 + params.length * 40);
                    //$('.ui-dialog[aria-describedby="dialog-parameters"]').css('height', '90%');
                    $dialog.data('callback', callback);
                    $dialog.data('obj', obj);
                    $dialog.dialog('open');
                } else {
                    callback(null, obj);
                }
            } else {
                callback(null, obj);
            }
        }

        function step2_cmdExec(host, cmd, callback) {
            /*        $stdout.val('');
             $dialogCommand.dialog('open');
             stdout = '$ ./iobroker ' + cmd;
             $stdout.val(stdout);
             // genereate the unique id to coordinate the outputs
             cmdCallback = callback;*/
            currentInstallId = Math.floor(Math.random() * 0xFFFFFFE) + 1;
            cmdCallback = callback;

            socket.emit('cmdExec', host, currentInstallId, cmd, function (err) {
                if (err) {
                    cmdCallback && cmdCallback(err);
                    stdout += '\n' + _(err);
                    if ($stdout) $stdout.val(stdout);
                    cmdCallback = null;
                } else {
                    if (cmdCallback) cmdCallback();
                }
            });
        }

        function step2_addAdapter(host, name, callback) {
            step2_getAdaptersInfo(host, function (repo, installed) {
                var _obj = repo[name];

                if (!_obj) _obj = installed[name];

                if (_obj && _obj.license && _obj.license !== 'MIT') {
                    // Show license dialog!
                    step2_showLicenseDialog(_obj, function (isAgree) {
                        if (isAgree) {
                            step2_cmdExec(host, 'install ' + name, function (exitCode) {
                                callback && callback(exitCode);
                            });
                        } else {
                            callback && callback(_('license not agree'));
                        }
                    });
                } else {
                    step2_cmdExec(host, 'install ' + name, function (exitCode) {
                        callback && callback(exitCode);
                    });
                }
            });
        }

        function step2_processInstance(task, callback) {
            $('.step2-progress[data-id="' + task._id + '"]').html(_('Install package'));

            // get Object
            socket.emit('getObject', task._id, function (err, obj) {
                if (obj && task.comment.add) {
                    $('.step2-progress[data-id="' + task._id + '"]').html(_('yet exists')).addClass('error');
                    callback && callback();
                } else {
                    if (obj) {
                        // we changing the existing instance
                        step2_addInstance(obj, task, callback);
                    } else {
                        // try to get system.adapter.NAME
                        var name = task._id.split('.');
                        name.pop();
                        name = name.join('.');

                        // if adapter installed or not
                        socket.emit('getObject', name, function (err, template) {
                            if (template) {
                                step2_addInstance(template, task, callback);
                            } else {
                                name = name.substring('system.adapter.'.length);
                                if (repos && repos[task.common.host] && repos[task.common.host].curInstalled[name]) {
                                    template = JSON.parse(JSON.stringify(repos[task.common.host].curInstalled[name]));
                                    step2_addInstance(template, task, callback);
                                } else {
                                    // add adapter
                                    step2_addAdapter(task.common.host, name, function (err) {
                                        if (err) {
                                            $('.step2-progress[data-id="' + task._id + '"]').html(_('Error: %s', err)).addClass('error');
                                            callback && callback();
                                        } else {
                                            repos[task.common.host] = null;
                                            step2_getAdapterInfo(task.common.host, name, function (template) {
                                                if (template) {
                                                    if (template.instanceObjects !== undefined) delete template.instanceObjects;
                                                    if (template.objects !== undefined) delete template.objects;
                                                    if (template._existing !== undefined) delete template._existing;
                                                    step2_addInstance(template, task, callback);
                                                } else {
                                                    $('.step2-progress[data-id="' + task._id + '"]').html(_('No io-package.json found', err)).addClass('error');
                                                    callback && callback();
                                                }
                                            });
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
            });
        }

        function step2_processInstances(instances, callback) {
            if (!instances || !instances.length) {
                callback();
                return;
            }
            var task = instances.shift();
            step2_processInstance(task, function () {
                setTimeout(function () {
                    step2_processInstances(instances, callback)
                }, 0);
            });
        }

        function step2() {
            var text = '';
            var instances = [];
            $('#step2_prev').button('disable');
            var $details = $('#step2_show_details');

            if (!$details.data('inited')) {
                $details.data('inited', true);
                $details.button({
                    label: _($details.data('title')),
                    icons: {
                        primary: 'ui-icon-comment'
                    }
                }).unbind('click').click(function () {
                    if ($stdout.is(':visible')) {
                        $stdout.hide();
                    } else {
                        $stdout.show();
                    }
                });
                var $dialog = $('#dialog-parameters');
                $dialog.dialog({
                    autoOpen:   false,
                    modal:      true,
                    width:      '80%',
//                    height:     '90%',
                    open:       function (event) {
                        $(event.target).parent().find('.ui-dialog-titlebar-close .ui-button-text').html('');
                    },
                    buttons:    [
                        {
                            text: _('Ok'),
                            click: function () {
                                var $dialog = $('#dialog-parameters');
                                var obj = $dialog.data('obj');
                                var error = false;
                                $dialog.find('.params').each(function () {
                                    var name = $(this).data('name');
                                    var val;
                                    if ($(this).attr('type') === 'checkbox') {
                                        val = $(this).prop('checked');
                                    } else {
                                        val = $(this).val();
                                    }
                                    if ($(this).prop('type') === 'password') {
                                        if (val !== $dialog.find('.passRepeat[data-name="' + name + '"]').val()) {
                                            showMessage(_('Passwords does not match'), _('Error'), 'alert');
                                            error = true;
                                            return;
                                        }
                                    }

                                    setParam(name, obj, val);
                                });
                                if (!error) {
                                    $dialog.dialog('close');
                                    var callback = $dialog.data('callback');
                                    if (callback && typeof callback === 'function') {
                                        $dialog.data('callback', null);
                                        $dialog.data('obj', null);
                                        callback(null, obj);
                                    }
                                }
                            }
                        },
                        {
                            text: _('Cancel'),
                            click: function () {
                                var $dialog = $('#dialog-parameters');
                                $dialog.dialog('close');
                                var callback = $dialog.data('callback');
                                if (callback && typeof callback === 'function') {
                                    $dialog.data('callback', null);
                                    callback(null, null);
                                }
                            }
                        }
                    ]
                });
            }

            $('.step1-allow').each(function () {
                if ($(this).prop('checked')) {
                    var i = $(this).data('id');
                    text += '<tr>';
                    text += '<td>' + newInstances[i]._id.substring('system.adapter.'.length) + '</td>';
                    text += '<td data-id="' + newInstances[i]._id + '" class="step2-progress">' + _('create instance') + '</td>';
                    text += '</tr>';
                    instances.push(newInstances[i]);
                    newInstances[i].common.host = $('.step1-host[data-id="' + i + '"]').val();
                }
            });

            $('#step2_instances').html(text);

            step2_processInstances(instances, function () {
                $('#step2_prev').button('enable');
            });
        }

        function load(settings, onChange) {
            $('.header').hide();
            // step 0

            $('.bottom-next').each(function () {
                $(this).button({
                    label: _($(this).data('title')),
                    icons: {
                        primary: 'ui-icon-seek-next'
                    }
                }).click(function () {
                    showStep(currentStep + 1);
                });
            });

            $('.bottom-prev').each(function () {
                $(this).button({
                    label: _($(this).data('title')),
                    icons: {
                        primary: 'ui-icon-seek-prev'
                    }
                }).click(function () {
                    showStep(currentStep - 1);
                });
            });

            $('.bottom-close').each(function () {
                $(this).button({
                    label: _($(this).data('title')),
                    icons: {
                        primary: 'ui-icon-closethick'
                    }
                }).click(function () {
                    window.close();
                    if (typeof parent !== 'undefined' && parent && parent.$iframeDialog) {
                        parent.$iframeDialog.dialog('close');
                    }
                });
            });

            showStep(0);
            $stdout = $('#stdout');

            socket.emit('subscribeStates',  'discovery.' + instance + '.*');
            socket.on('stateChange', function (id, state) {
                if (state && state.ack && id === 'discovery.' + instance + '.devicesProgress') {
                    $('#step0_text').show().html(_('Lookup devices') + ' - ' + state.val + '%');
                    $('#step0_progressbar').show().progressbar({value: state.val});
                }
                if (state && state.ack && id === 'discovery.' + instance + '.servicesProgress') {
                    $('#step0_text').show().html(_('Lookup services') + ' - ' + state.val + '%');
                    $('#step0_progressbar').show().progressbar({value: state.val});
                }
            });

            socket.on('cmdStdout', function (_id, text) {
                if (currentInstallId === _id) {
                    stdout += '\n' + text;
                    $stdout.val(stdout);
                    $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                }
            });

            socket.on('cmdStderr', function (_id, text) {
                if (currentInstallId === _id) {
                    stdout += '\nERROR: ' + text;
                    if ($stdout) {
                        $stdout.val(stdout);
                        $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                    }
                }
            });

            socket.on('cmdExit', function (_id, exitCode) {
                if (currentInstallId === _id) {
                    exitCode = parseInt(exitCode, 10);
                    stdout += '\n' + (exitCode !== 0 ? 'ERROR: ' : '') + 'process exited with code ' + exitCode;
                    if ($stdout) {
                        $stdout.val(stdout);
                        $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());
                    }
                    if (cmdCallback) {
                        cmdCallback(exitCode);
                        cmdCallback = null;
                    }
                }
            });

            onChange(false);
        }

        function save(callback) {
            // do nothing
            callback();
        }

        var steps = [
            step0,
            step1,
            step2
        ];
    </script>
    <style>
        .discovery-state-active {
            background: lightgreen;
        }
        .wizard-header {
            width: calc(100% - 6px - 1rem);
            position: absolute;
            top: 0;
            height: 3rem;
            padding-left: 1rem;
        }
        .wizard-content {
            width: calc(100% - 26px);
            position: absolute;
            top: 3rem;
            height: calc(100% - 6rem - 20px);
            padding: 10px;
            overflow: auto;
        }
        .wizard-footer {
            width: calc(100% - 16px);
            position: absolute;
            bottom: 0;
            height: calc(3rem - 10px);
            padding: 5px;
            background: black;
            text-align: right;
        }
        .wizard-table {
            width: 100%;
        }
        .wizard-table th {
            background: #338ce6;
            color: white;
            text-align: left;
        }
        .wizard-table tr:nth-child(even) {
            background: #CCC;
        }
        .wizard-table tr:nth-child(odd) {
            background: #FFF;
        }
        #step2_instances td, #step2_instances th {
            padding-left: 5px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .warn {
            color: orange;
        }
        #step0_settings {
            float: left;
        }
        .param-line {
            height: 27px;
        }
        .param-line input {
            margin-bottom: 2px;
        }
</style>
</head>
<body>
<div style="width: 100%; height: 100%" id="container">
    <div data-step="0" class="wizard-page" style="display: none">
        <div class="wizard-header ui-widget-header">
            <h3 class="translate">Step1 - Discover all possible devices</h3>
        </div>
        <div class="wizard-content">
            <div id="step0_help1" class="translate">step0_help1</div>
            <div id="step0_help2" class="translate" style="display: none">step0_help2</div>
            <div id="step0_text" style="display: none"></div>
            <div id="step0_progressbar" style="display: none"></div>
        </div>
        <div class="wizard-footer">
            <button id="step0_settings" class="bottom-buttons" data-title="Settings"></button>
            <button id="step0_discover" class="bottom-buttons ui-state-active" data-title="Discover"></button>
            <button id="step0_next" class="bottom-buttons bottom-next" data-title="Next"></button>
            <button id="step0_close" class="bottom-buttons bottom-close" data-title="Close"></button>
        </div>
    </div>
    <div data-step="1" class="wizard-page" style="display: none">
        <div class="wizard-header ui-widget-header">
            <h3 class="translate">Create instances automatically</h3>
        </div>
        <div class="wizard-content">
            <button style="display: inline-block; height: 24px;" data-title="Select all" id="step1_selectall"></button>
            <button style="display: inline-block; height: 24px;" data-title="Deselect all" id="step1_deselectall"></button>
            <button style="display: inline-block; height: 24px; font-size: 12px;" data-title="Show all" id="step1-show-acknowledged"></button>
            <button style="display: inline-block; height: 24px; font-size: 12px;" data-title="Show all" id="step1-show-suggested"></button>
            <table class="wizard-table">
                <thead>
                <tr>
                    <th class="translate">Use</th>
                    <th class="translate">Instance</th>
                    <th class="translate">Host</th>
                    <th class="translate">Description</th>
                    <th class="translate translateT" title="Do not show this instance any more">Ack</th>
                </tr>
                </thead>
                <tbody id="step1_instances">

                </tbody>
            </table>
        </div>
        <div class="wizard-footer">
            <button id="step1_prev"  class="bottom-buttons bottom-prev"  data-title="Back"></button>
            <button id="step1_next"  class="bottom-buttons bottom-next ui-state-active"  data-title="Create instances"></button>
            <button id="step1_close" class="bottom-buttons bottom-close" data-title="Close"></button>
        </div>
    </div>
    <div data-step="2" class="wizard-page" style="display: none">
        <div class="wizard-header ui-widget-header">
            <h3 class="translate">Install adapters</h3>
        </div>
        <div class="wizard-content">
            <table class="wizard-table">
                <thead>
                <tr>
                    <th class="translate" style="width: 200px">Instance</th>
                    <th class="translate">Progress</th>
                </tr>
                </thead>
                <tbody id="step2_instances">
                </tbody>
            </table>
            <button id="step2_show_details" data-title="Details"></button>
            <textarea style="font-family: courier, monospace; font-size: 11px; resize: none; display: none" id="stdout" disabled="disabled" cols="120" rows="10"></textarea>
        </div>
        <div class="wizard-footer">
            <button id="step2_prev"  class="bottom-buttons bottom-prev"  data-title="Back"></button>
            <button id="step2_close" class="bottom-buttons bottom-close ui-state-active" data-title="Finish"></button>
        </div>
    </div>
</div>
<div id="dialog-license" title="license agreement" class="translateT" style="display: none; z-index: 102">
    <table><tr><td id="license_language_label"><label class="translate" for="license_language">Select language</label></td>
        <td><select id="license_language">
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="ru"></option>
        </select></td></tr>
    </table>
    <input id="license_diag" type="checkbox"/><span class="translate" id="license_checkbox" style="color:red">license_checkbox</span>
    <h3 id="license_terms" class="translate">License terms</h3>
    <div id="license_text" style="width: 100%"></div>
</div>

<div id="dialog-parameters" style="display: none; z-index: 102">
</div>

</body>
</html>